{"ast":null,"code":"import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Button from 'src/components/Button';\nimport { styled, t } from '@superset-ui/core';\n\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport Tabs from 'src/common/components/Tabs';\nimport adhocMetricType from 'src/explore/components/controls/MetricControl/adhocMetricType';\nimport columnType from './columnType';\nimport AdhocFilter, { EXPRESSION_TYPES } from './AdhocFilter';\nimport AdhocFilterEditPopoverSimpleTabContent from './AdhocFilterEditPopoverSimpleTabContent';\nimport AdhocFilterEditPopoverSqlTabContent from './AdhocFilterEditPopoverSqlTabContent';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  adhocFilter: PropTypes.instanceOf(AdhocFilter).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  options: PropTypes.arrayOf(\n  PropTypes.oneOfType([\n  columnType,\n  PropTypes.shape({ saved_metric_name: PropTypes.string.isRequired }),\n  adhocMetricType])).\n\n  isRequired,\n  datasource: PropTypes.object,\n  partitionColumn: PropTypes.string,\n  theme: PropTypes.object };\n\n\nconst ResizeIcon = styled.i`\n  margin-left: ${({ theme }) => theme.gridUnit * 2}px;\n`;\n\nconst startingWidth = 320;\nconst startingHeight = 240;\n\nexport default class AdhocFilterEditPopover extends React.Component {\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6;\n    super(props);\n    this.onSave = _bindInstanceProperty(_context = this.onSave).call(_context, this);\n    this.onDragDown = _bindInstanceProperty(_context2 = this.onDragDown).call(_context2, this);\n    this.onMouseMove = _bindInstanceProperty(_context3 = this.onMouseMove).call(_context3, this);\n    this.onMouseUp = _bindInstanceProperty(_context4 = this.onMouseUp).call(_context4, this);\n    this.onAdhocFilterChange = _bindInstanceProperty(_context5 = this.onAdhocFilterChange).call(_context5, this);\n    this.adjustHeight = _bindInstanceProperty(_context6 = this.adjustHeight).call(_context6, this);\n\n    this.state = {\n      adhocFilter: this.props.adhocFilter,\n      width: startingWidth,\n      height: startingHeight };\n\n\n    this.popoverContentRef = /*#__PURE__*/React.createRef();\n  }\n\n  componentDidMount() {\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onAdhocFilterChange(adhocFilter) {\n    this.setState({ adhocFilter });\n  }\n\n  onSave() {\n    this.props.onChange(this.state.adhocFilter);\n    this.props.onClose();\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n      this.dragStartWidth + (e.clientX - this.dragStartX),\n      startingWidth),\n\n      height: Math.max(\n      this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n      startingHeight) });\n\n\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  adjustHeight(heightDifference) {\n    this.setState(state => ({ height: state.height + heightDifference }));\n  }\n\n  render() {\n    const {\n      adhocFilter: propsAdhocFilter,\n      options,\n      onChange,\n      onClose,\n      onResize,\n      datasource,\n      partitionColumn,\n      theme,\n      ...popoverProps } =\n    this.props;\n\n    const { adhocFilter } = this.state;\n\n    const stateIsValid = adhocFilter.isValid();\n    const hasUnsavedChanges = !adhocFilter.equals(propsAdhocFilter);\n\n    return (\n      ___EmotionJSX(\"div\", _extends({\n        id: \"filter-edit-popover\" },\n      popoverProps, {\n        \"data-test\": \"filter-edit-popover\",\n        ref: this.popoverContentRef }),\n\n      ___EmotionJSX(Tabs, {\n        id: \"adhoc-filter-edit-tabs\",\n        defaultActiveKey: adhocFilter.expressionType,\n        className: \"adhoc-filter-edit-tabs\",\n        \"data-test\": \"adhoc-filter-edit-tabs\",\n        style: { minHeight: this.state.height, width: this.state.width },\n        allowOverflow: true },\n\n      ___EmotionJSX(Tabs.TabPane, {\n        className: \"adhoc-filter-edit-tab\",\n        key: EXPRESSION_TYPES.SIMPLE,\n        tab: t('Simple') },\n\n      ___EmotionJSX(ErrorBoundary, null,\n      ___EmotionJSX(AdhocFilterEditPopoverSimpleTabContent, {\n        adhocFilter: this.state.adhocFilter,\n        onChange: this.onAdhocFilterChange,\n        options: options,\n        datasource: datasource,\n        onHeightChange: this.adjustHeight,\n        partitionColumn: partitionColumn,\n        popoverRef: this.popoverContentRef.current }))),\n\n\n\n      ___EmotionJSX(Tabs.TabPane, {\n        className: \"adhoc-filter-edit-tab\",\n        key: EXPRESSION_TYPES.SQL,\n        tab: t('Custom SQL') },\n\n      ___EmotionJSX(ErrorBoundary, null,\n      !this.props.datasource ||\n      this.props.datasource.type !== 'druid' ?\n      ___EmotionJSX(AdhocFilterEditPopoverSqlTabContent, {\n        adhocFilter: this.state.adhocFilter,\n        onChange: this.onAdhocFilterChange,\n        options: this.props.options,\n        height: this.state.height }) :\n\n\n      ___EmotionJSX(\"div\", { className: \"custom-sql-disabled-message\" }, \"Custom SQL Filters are not available on druid datasources\")))),\n\n\n\n\n\n\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(Button, { buttonSize: \"small\", onClick: this.props.onClose, cta: true },\n      t('Close')),\n\n      ___EmotionJSX(Button, {\n        \"data-test\": \"adhoc-filter-edit-popover-save-button\",\n        disabled: !stateIsValid,\n        buttonStyle:\n        hasUnsavedChanges && stateIsValid ? 'primary' : 'default',\n\n        buttonSize: \"small\",\n        className: \"m-r-5\",\n        onClick: this.onSave,\n        cta: true },\n\n      t('Save')),\n\n      ___EmotionJSX(ResizeIcon, {\n        role: \"button\",\n        \"aria-label\": \"Resize\",\n        tabIndex: 0,\n        onMouseDown: this.onDragDown,\n        className: \"fa fa-expand edit-popover-resize text-muted\" }))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nAdhocFilterEditPopover.propTypes = propTypes;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx\");reactHotLoader.register(ResizeIcon, \"ResizeIcon\", \"/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx\");reactHotLoader.register(startingWidth, \"startingWidth\", \"/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx\");reactHotLoader.register(startingHeight, \"startingHeight\", \"/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx\");reactHotLoader.register(AdhocFilterEditPopover, \"AdhocFilterEditPopover\", \"/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/explore/components/controls/FilterControl/AdhocFilterEditPopover.jsx"],"names":["React","PropTypes","Button","styled","t","ErrorBoundary","Tabs","adhocMetricType","columnType","AdhocFilter","EXPRESSION_TYPES","AdhocFilterEditPopoverSimpleTabContent","AdhocFilterEditPopoverSqlTabContent","propTypes","adhocFilter","instanceOf","isRequired","onChange","func","onClose","onResize","options","arrayOf","oneOfType","shape","saved_metric_name","string","datasource","object","partitionColumn","theme","ResizeIcon","i","gridUnit","startingWidth","startingHeight","AdhocFilterEditPopover","Component","constructor","props","onSave","onDragDown","onMouseMove","onMouseUp","onAdhocFilterChange","adjustHeight","state","width","height","popoverContentRef","createRef","componentDidMount","document","addEventListener","componentWillUnmount","removeEventListener","setState","e","dragStartX","clientX","dragStartY","clientY","dragStartWidth","dragStartHeight","Math","max","heightDifference","render","propsAdhocFilter","popoverProps","stateIsValid","isValid","hasUnsavedChanges","equals","expressionType","minHeight","SIMPLE","current","SQL","type"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport Button from 'src/components/Button';\nimport { styled, t } from '@superset-ui/core';\n\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport Tabs from 'src/common/components/Tabs';\nimport adhocMetricType from 'src/explore/components/controls/MetricControl/adhocMetricType';\nimport columnType from './columnType';\nimport AdhocFilter, { EXPRESSION_TYPES } from './AdhocFilter';\nimport AdhocFilterEditPopoverSimpleTabContent from './AdhocFilterEditPopoverSimpleTabContent';\nimport AdhocFilterEditPopoverSqlTabContent from './AdhocFilterEditPopoverSqlTabContent';\n\nconst propTypes = {\n  adhocFilter: PropTypes.instanceOf(AdhocFilter).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  options: PropTypes.arrayOf(\n    PropTypes.oneOfType([\n      columnType,\n      PropTypes.shape({ saved_metric_name: PropTypes.string.isRequired }),\n      adhocMetricType,\n    ]),\n  ).isRequired,\n  datasource: PropTypes.object,\n  partitionColumn: PropTypes.string,\n  theme: PropTypes.object,\n};\n\nconst ResizeIcon = styled.i`\n  margin-left: ${({ theme }) => theme.gridUnit * 2}px;\n`;\n\nconst startingWidth = 320;\nconst startingHeight = 240;\n\nexport default class AdhocFilterEditPopover extends React.Component {\n  constructor(props) {\n    super(props);\n    this.onSave = this.onSave.bind(this);\n    this.onDragDown = this.onDragDown.bind(this);\n    this.onMouseMove = this.onMouseMove.bind(this);\n    this.onMouseUp = this.onMouseUp.bind(this);\n    this.onAdhocFilterChange = this.onAdhocFilterChange.bind(this);\n    this.adjustHeight = this.adjustHeight.bind(this);\n\n    this.state = {\n      adhocFilter: this.props.adhocFilter,\n      width: startingWidth,\n      height: startingHeight,\n    };\n\n    this.popoverContentRef = React.createRef();\n  }\n\n  componentDidMount() {\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onAdhocFilterChange(adhocFilter) {\n    this.setState({ adhocFilter });\n  }\n\n  onSave() {\n    this.props.onChange(this.state.adhocFilter);\n    this.props.onClose();\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n        this.dragStartWidth + (e.clientX - this.dragStartX),\n        startingWidth,\n      ),\n      height: Math.max(\n        this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n        startingHeight,\n      ),\n    });\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  adjustHeight(heightDifference) {\n    this.setState(state => ({ height: state.height + heightDifference }));\n  }\n\n  render() {\n    const {\n      adhocFilter: propsAdhocFilter,\n      options,\n      onChange,\n      onClose,\n      onResize,\n      datasource,\n      partitionColumn,\n      theme,\n      ...popoverProps\n    } = this.props;\n\n    const { adhocFilter } = this.state;\n\n    const stateIsValid = adhocFilter.isValid();\n    const hasUnsavedChanges = !adhocFilter.equals(propsAdhocFilter);\n\n    return (\n      <div\n        id=\"filter-edit-popover\"\n        {...popoverProps}\n        data-test=\"filter-edit-popover\"\n        ref={this.popoverContentRef}\n      >\n        <Tabs\n          id=\"adhoc-filter-edit-tabs\"\n          defaultActiveKey={adhocFilter.expressionType}\n          className=\"adhoc-filter-edit-tabs\"\n          data-test=\"adhoc-filter-edit-tabs\"\n          style={{ minHeight: this.state.height, width: this.state.width }}\n          allowOverflow\n        >\n          <Tabs.TabPane\n            className=\"adhoc-filter-edit-tab\"\n            key={EXPRESSION_TYPES.SIMPLE}\n            tab={t('Simple')}\n          >\n            <ErrorBoundary>\n              <AdhocFilterEditPopoverSimpleTabContent\n                adhocFilter={this.state.adhocFilter}\n                onChange={this.onAdhocFilterChange}\n                options={options}\n                datasource={datasource}\n                onHeightChange={this.adjustHeight}\n                partitionColumn={partitionColumn}\n                popoverRef={this.popoverContentRef.current}\n              />\n            </ErrorBoundary>\n          </Tabs.TabPane>\n          <Tabs.TabPane\n            className=\"adhoc-filter-edit-tab\"\n            key={EXPRESSION_TYPES.SQL}\n            tab={t('Custom SQL')}\n          >\n            <ErrorBoundary>\n              {!this.props.datasource ||\n              this.props.datasource.type !== 'druid' ? (\n                <AdhocFilterEditPopoverSqlTabContent\n                  adhocFilter={this.state.adhocFilter}\n                  onChange={this.onAdhocFilterChange}\n                  options={this.props.options}\n                  height={this.state.height}\n                />\n              ) : (\n                <div className=\"custom-sql-disabled-message\">\n                  Custom SQL Filters are not available on druid datasources\n                </div>\n              )}\n            </ErrorBoundary>\n          </Tabs.TabPane>\n        </Tabs>\n        <div>\n          <Button buttonSize=\"small\" onClick={this.props.onClose} cta>\n            {t('Close')}\n          </Button>\n          <Button\n            data-test=\"adhoc-filter-edit-popover-save-button\"\n            disabled={!stateIsValid}\n            buttonStyle={\n              hasUnsavedChanges && stateIsValid ? 'primary' : 'default'\n            }\n            buttonSize=\"small\"\n            className=\"m-r-5\"\n            onClick={this.onSave}\n            cta\n          >\n            {t('Save')}\n          </Button>\n          <ResizeIcon\n            role=\"button\"\n            aria-label=\"Resize\"\n            tabIndex={0}\n            onMouseDown={this.onDragDown}\n            className=\"fa fa-expand edit-popover-resize text-muted\"\n          />\n        </div>\n      </div>\n    );\n  }\n}\n\nAdhocFilterEditPopover.propTypes = propTypes;\n"]},"metadata":{},"sourceType":"module"}