{"ast":null,"code":"import _Set from \"@babel/runtime-corejs3/core-js-stable/set\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";import _startsWithInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/starts-with\";import _sortInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/sort\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _findInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/find\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _Array$isArray from \"@babel/runtime-corejs3/core-js-stable/array/is-array\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";import _debounce from \"lodash/debounce\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\n\nimport { max as d3Max } from 'd3-array';\nimport { AsyncCreatableSelect, CreatableSelect } from 'src/components/Select';\nimport Button from 'src/components/Button';\nimport { t, SupersetClient } from '@superset-ui/core';\n\nimport {\nBOOL_FALSE_DISPLAY,\nBOOL_TRUE_DISPLAY,\nSLOW_DEBOUNCE } from\n'src/constants';\nimport FormLabel from 'src/components/FormLabel';\nimport DateFilterControl from 'src/explore/components/controls/DateFilterControl';\nimport ControlRow from 'src/explore/components/ControlRow';\nimport Control from 'src/explore/components/Control';\nimport { controls } from 'src/explore/controls';\nimport { getExploreUrl } from 'src/explore/exploreUtils';\nimport OnPasteSelect from 'src/components/Select/OnPasteSelect';\nimport {\nFILTER_CONFIG_ATTRIBUTES,\nFILTER_OPTIONS_LIMIT,\nTIME_FILTER_LABELS,\nTIME_FILTER_MAP } from\n'src/explore/constants';\n\nimport './FilterBox.less';\n\n// a shortcut to a map key, used by many components\nimport { jsx as ___EmotionJSX } from \"@emotion/core\";export const TIME_RANGE = TIME_FILTER_MAP.time_range;\n\nconst propTypes = {\n  chartId: PropTypes.number.isRequired,\n  origSelectedValues: PropTypes.object,\n  datasource: PropTypes.object.isRequired,\n  instantFiltering: PropTypes.bool,\n  filtersFields: PropTypes.arrayOf(\n  PropTypes.shape({\n    field: PropTypes.string,\n    label: PropTypes.string })),\n\n\n  filtersChoices: PropTypes.objectOf(\n  PropTypes.arrayOf(\n  PropTypes.shape({\n    id: PropTypes.string,\n    text: PropTypes.string,\n    filter: PropTypes.string,\n    metric: PropTypes.number }))),\n\n\n\n  onChange: PropTypes.func,\n  onFilterMenuOpen: PropTypes.func,\n  onFilterMenuClose: PropTypes.func,\n  showDateFilter: PropTypes.bool,\n  showSqlaTimeGrain: PropTypes.bool,\n  showSqlaTimeColumn: PropTypes.bool,\n  showDruidTimeGrain: PropTypes.bool,\n  showDruidTimeOrigin: PropTypes.bool };\n\nconst defaultProps = {\n  origSelectedValues: {},\n  onChange: () => {},\n  onFilterMenuOpen: () => {},\n  onFilterMenuClose: () => {},\n  showDateFilter: false,\n  showSqlaTimeGrain: false,\n  showSqlaTimeColumn: false,\n  showDruidTimeGrain: false,\n  showDruidTimeOrigin: false,\n  instantFiltering: false };\n\n\nclass FilterBox extends React.PureComponent {\n  constructor(props) {var _context, _context2, _context3, _context4;\n    super(props);this.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n    onCloseDateFilterControl = () => this.onFilterMenuClose(TIME_RANGE);this.state = { selectedValues: props.origSelectedValues, // this flag is used by non-instant filter, to make the apply button enabled/disabled\n      hasChanged: false };this.debouncerCache = {};this.maxValueCache = {};this.changeFilter = _bindInstanceProperty(_context = this.changeFilter).call(_context, this);this.onFilterMenuOpen = _bindInstanceProperty(_context2 = this.onFilterMenuOpen).call(_context2, this);this.onOpenDateFilterControl = _bindInstanceProperty(_context3 = this.onOpenDateFilterControl).call(_context3, this);this.onFilterMenuClose = _bindInstanceProperty(_context4 = this.onFilterMenuClose).call(_context4, this);}onFilterMenuOpen(column) {return this.props.onFilterMenuOpen(this.props.chartId, column);}onFilterMenuClose(column) {return this.props.onFilterMenuClose(this.props.chartId, column);}onOpenDateFilterControl() {return this.onFilterMenuOpen(TIME_RANGE);}\n  getControlData(controlName) {\n    const { selectedValues } = this.state;\n    const control = {\n      ...controls[controlName], // TODO: make these controls ('druid_time_origin', 'granularity', 'granularity_sqla', 'time_grain_sqla') accessible from getControlsForVizType.\n      name: controlName,\n      key: `control-${controlName}`,\n      value: selectedValues[TIME_FILTER_MAP[controlName]],\n      actions: { setControlValue: this.changeFilter } };\n\n    const mapFunc = control.mapStateToProps;\n    return mapFunc ? { ...control, ...mapFunc(this.props) } : control;\n  }\n\n  /**\n   * Get known max value of a column\n   */\n  getKnownMax(key, choices) {\n    this.maxValueCache[key] = Math.max(\n    this.maxValueCache[key] || 0,\n    d3Max(choices || this.props.filtersChoices[key] || [], x => x.metric));\n\n    return this.maxValueCache[key];\n  }\n\n  clickApply() {\n    const { selectedValues } = this.state;\n    this.setState({ hasChanged: false }, () => {\n      this.props.onChange(selectedValues, false);\n    });\n  }\n\n  changeFilter(filter, options) {\n    const fltr = TIME_FILTER_MAP[filter] || filter;\n    let vals = null;\n    if (options !== null) {\n      if (_Array$isArray(options)) {\n        vals = _mapInstanceProperty(options).call(options, opt => typeof opt === 'string' ? opt : opt.value);\n      } else if (options.value) {\n        vals = options.value;\n      } else {\n        vals = options;\n      }\n    }\n\n    this.setState(\n    prevState => ({\n      selectedValues: {\n        ...prevState.selectedValues,\n        [fltr]: vals },\n\n      hasChanged: true }),\n\n    () => {\n      if (this.props.instantFiltering) {\n        this.props.onChange({ [fltr]: vals }, false);\n      }\n    });\n\n  }\n\n  /**\n   * Generate a debounce function that loads options for a specific column\n   */\n  debounceLoadOptions(key) {\n    if (!(key in this.debouncerCache)) {\n      this.debouncerCache[key] = _debounce((input, callback) => {\n        this.loadOptions(key, input).then(callback);\n      }, SLOW_DEBOUNCE);\n    }\n    return this.debouncerCache[key];\n  }\n\n  /**\n   * Transform select options, add bar background\n   */\n  transformOptions(options, max) {\n    const maxValue = max === undefined ? d3Max(options, x => x.metric) : max;\n    return _mapInstanceProperty(options).call(options, opt => {\n      const perc = Math.round(opt.metric / maxValue * 100);\n      const color = 'lightgrey';\n      const backgroundImage = `linear-gradient(to right, ${color}, ${color} ${perc}%, rgba(0,0,0,0) ${perc}%`;\n      const style = { backgroundImage };\n      let label = opt.id;\n      if (label === true) {\n        label = BOOL_TRUE_DISPLAY;\n      } else if (label === false) {\n        label = BOOL_FALSE_DISPLAY;\n      }\n      return { value: opt.id, label, style };\n    });\n  }\n\n  async loadOptions(key, inputValue = '') {var _context5, _context6, _json$data;\n    const input = inputValue.toLowerCase();\n    const sortAsc = _findInstanceProperty(_context5 = this.props.filtersFields).call(_context5, x => x.key === key).asc;\n    const formData = {\n      ...this.props.rawFormData,\n      adhoc_filters: inputValue ?\n      [\n      {\n        clause: 'WHERE',\n        comparator: null,\n        expressionType: 'SQL',\n        // TODO: Evaluate SQL Injection risk\n        sqlExpression: `lower(${key}) like '%${input}%'` }] :\n\n\n      null };\n\n\n    const { json } = await SupersetClient.get({\n      url: getExploreUrl({\n        formData,\n        endpointType: 'json',\n        method: 'GET' }) });\n\n\n    const options = _filterInstanceProperty(_context6 = (json == null ? void 0 : (_json$data = json.data) == null ? void 0 : _json$data[key]) || []).call(_context6, x => x.id);\n    if (!options || options.length === 0) {\n      return [];\n    }\n    if (input) {\n      // sort those starts with search query to front\n      _sortInstanceProperty(options).call(options, (a, b) => {\n        const labelA = a.id.toLowerCase();\n        const labelB = b.id.toLowerCase();\n        const textOrder = _startsWithInstanceProperty(labelB).call(labelB, input) - _startsWithInstanceProperty(labelA).call(labelA, input);\n        return textOrder === 0 ?\n        (a.metric - b.metric) * (sortAsc ? 1 : -1) :\n        textOrder;\n      });\n    }\n    return this.transformOptions(options, this.getKnownMax(key, options));\n  }\n\n  renderDateFilter() {\n    const { showDateFilter } = this.props;\n    const label = TIME_FILTER_LABELS.time_range;\n    if (showDateFilter) {\n      return (\n        ___EmotionJSX(\"div\", { className: \"row space-1\" },\n        ___EmotionJSX(\"div\", {\n          className: \"col-lg-12 col-xs-12\",\n          \"data-test\": \"date-filter-container\" },\n\n        ___EmotionJSX(DateFilterControl, {\n          name: TIME_RANGE,\n          label: label,\n          description: t('Select start and end date'),\n          onChange: newValue => {\n            this.changeFilter(TIME_RANGE, newValue);\n          },\n          onOpenDateFilterControl: this.onOpenDateFilterControl,\n          onCloseDateFilterControl: this.onCloseDateFilterControl,\n          value: this.state.selectedValues[TIME_RANGE] || 'No filter' }))));\n\n\n\n\n    }\n    return null;\n  }\n\n  renderDatasourceFilters() {\n    const {\n      showSqlaTimeGrain,\n      showSqlaTimeColumn,\n      showDruidTimeGrain,\n      showDruidTimeOrigin } =\n    this.props;\n    const datasourceFilters = [];\n    const sqlaFilters = [];\n    const druidFilters = [];\n    if (showSqlaTimeGrain) sqlaFilters.push('time_grain_sqla');\n    if (showSqlaTimeColumn) sqlaFilters.push('granularity_sqla');\n    if (showDruidTimeGrain) druidFilters.push('granularity');\n    if (showDruidTimeOrigin) druidFilters.push('druid_time_origin');\n    if (sqlaFilters.length) {\n      datasourceFilters.push(\n      ___EmotionJSX(ControlRow, {\n        key: \"sqla-filters\",\n        controls: _mapInstanceProperty(sqlaFilters).call(sqlaFilters, (control) =>\n        ___EmotionJSX(Control, this.getControlData(control))) }));\n\n\n\n    }\n    if (druidFilters.length) {\n      datasourceFilters.push(\n      ___EmotionJSX(ControlRow, {\n        key: \"druid-filters\",\n        controls: _mapInstanceProperty(druidFilters).call(druidFilters, (control) =>\n        ___EmotionJSX(Control, this.getControlData(control))) }));\n\n\n\n    }\n    return datasourceFilters;\n  }\n\n  renderSelect(filterConfig) {var _context7, _context8;\n    const { filtersChoices } = this.props;\n    const { selectedValues } = this.state;\n    this.debouncerCache = {};\n    this.maxValueCache = {};\n\n    // Add created options to filtersChoices, even though it doesn't exist,\n    // or these options will exist in query sql but invisible to end user.\n    _forEachInstanceProperty(_context7 = _filterInstanceProperty(_context8 = _Object$keys(selectedValues)).call(_context8,\n    key => key in filtersChoices)).call(_context7,\n    key => {var _context9;\n      // empty values are ignored\n      if (!selectedValues[key]) {\n        return;\n      }\n      const choices = filtersChoices[key] || (filtersChoices[key] = []);\n      const choiceIds = new _Set(_mapInstanceProperty(choices).call(choices, f => f.id));\n      const selectedValuesForKey = _Array$isArray(selectedValues[key]) ?\n      selectedValues[key] :\n      [selectedValues[key]];\n      _forEachInstanceProperty(_context9 = _filterInstanceProperty(selectedValuesForKey).call(selectedValuesForKey,\n      value => value !== null && !choiceIds.has(value))).call(_context9,\n      value => {\n        choices.unshift({\n          filter: key,\n          id: value,\n          text: value,\n          metric: 0 });\n\n      });\n    });\n    const {\n      key,\n      label,\n      [FILTER_CONFIG_ATTRIBUTES.MULTIPLE]: isMultiple,\n      [FILTER_CONFIG_ATTRIBUTES.DEFAULT_VALUE]: defaultValue,\n      [FILTER_CONFIG_ATTRIBUTES.CLEARABLE]: isClearable,\n      [FILTER_CONFIG_ATTRIBUTES.SEARCH_ALL_OPTIONS]: searchAllOptions } =\n    filterConfig;\n    const data = filtersChoices[key] || [];\n    let value = selectedValues[key] || null;\n\n    // Assign default value if required\n    if (value === undefined && defaultValue) {\n      // multiple values are separated by semicolons\n      value = isMultiple ? defaultValue.split(';') : defaultValue;\n    }\n\n    return (\n      ___EmotionJSX(OnPasteSelect, {\n        cacheOptions: true,\n        loadOptions: this.debounceLoadOptions(key),\n        defaultOptions: this.transformOptions(data),\n        key: key,\n        placeholder: t('Type or Select [%s]', label),\n        isMulti: isMultiple,\n        isClearable: isClearable,\n        value: value,\n        options: this.transformOptions(data),\n        onChange: newValue => {\n          // avoid excessive re-renders\n          if (newValue !== value) {\n            this.changeFilter(key, newValue);\n          }\n        }\n        // TODO try putting this back once react-select is upgraded\n        // onFocus={() => this.onFilterMenuOpen(key)}\n        , onMenuOpen: () => this.onFilterMenuOpen(key),\n        onBlur: () => this.onFilterMenuClose(key),\n        onMenuClose: () => this.onFilterMenuClose(key),\n        selectWrap:\n        searchAllOptions && data.length >= FILTER_OPTIONS_LIMIT ?\n        AsyncCreatableSelect :\n        CreatableSelect,\n\n        noResultsText: t('No results found'),\n        forceOverflow: true }));\n\n\n  }\n\n  renderFilters() {\n    const { filtersFields = [] } = this.props;\n    return _mapInstanceProperty(filtersFields).call(filtersFields, filterConfig => {\n      const { label, key } = filterConfig;\n      return (\n        ___EmotionJSX(\"div\", { key: key, className: \"m-b-5 filter-container\" },\n        ___EmotionJSX(FormLabel, { htmlFor: `LABEL-${key}` }, label),\n        this.renderSelect(filterConfig)));\n\n\n    });\n  }\n\n  render() {var _context10;\n    const { instantFiltering, width, height } = this.props;\n    return (\n      ___EmotionJSX(\"div\", { style: { width, height, overflow: 'auto' } },\n      this.renderDateFilter(),\n      this.renderDatasourceFilters(),\n      this.renderFilters(),\n      !instantFiltering &&\n      ___EmotionJSX(Button, {\n        buttonSize: \"small\",\n        buttonStyle: \"primary\",\n        onClick: _bindInstanceProperty(_context10 = this.clickApply).call(_context10, this),\n        disabled: !this.state.hasChanged },\n\n      t('Apply'))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}\nFilterBox.propTypes = propTypes;\nFilterBox.defaultProps = defaultProps;const _default =\n\nFilterBox;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(TIME_RANGE, \"TIME_RANGE\", \"/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx\");reactHotLoader.register(propTypes, \"propTypes\", \"/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx\");reactHotLoader.register(FilterBox, \"FilterBox\", \"/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/visualizations/FilterBox/FilterBox.jsx"],"names":["React","PropTypes","max","d3Max","AsyncCreatableSelect","CreatableSelect","Button","t","SupersetClient","BOOL_FALSE_DISPLAY","BOOL_TRUE_DISPLAY","SLOW_DEBOUNCE","FormLabel","DateFilterControl","ControlRow","Control","controls","getExploreUrl","OnPasteSelect","FILTER_CONFIG_ATTRIBUTES","FILTER_OPTIONS_LIMIT","TIME_FILTER_LABELS","TIME_FILTER_MAP","TIME_RANGE","time_range","propTypes","chartId","number","isRequired","origSelectedValues","object","datasource","instantFiltering","bool","filtersFields","arrayOf","shape","field","string","label","filtersChoices","objectOf","id","text","filter","metric","onChange","func","onFilterMenuOpen","onFilterMenuClose","showDateFilter","showSqlaTimeGrain","showSqlaTimeColumn","showDruidTimeGrain","showDruidTimeOrigin","defaultProps","FilterBox","PureComponent","constructor","props","onCloseDateFilterControl","state","selectedValues","hasChanged","debouncerCache","maxValueCache","changeFilter","onOpenDateFilterControl","column","getControlData","controlName","control","name","key","value","actions","setControlValue","mapFunc","mapStateToProps","getKnownMax","choices","Math","x","clickApply","setState","options","fltr","vals","opt","prevState","debounceLoadOptions","input","callback","loadOptions","then","transformOptions","maxValue","undefined","perc","round","color","backgroundImage","style","inputValue","toLowerCase","sortAsc","asc","formData","rawFormData","adhoc_filters","clause","comparator","expressionType","sqlExpression","json","get","url","endpointType","method","data","length","a","b","labelA","labelB","textOrder","renderDateFilter","newValue","renderDatasourceFilters","datasourceFilters","sqlaFilters","druidFilters","push","renderSelect","filterConfig","choiceIds","f","selectedValuesForKey","has","unshift","MULTIPLE","isMultiple","DEFAULT_VALUE","defaultValue","CLEARABLE","isClearable","SEARCH_ALL_OPTIONS","searchAllOptions","split","renderFilters","render","width","height","overflow"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { debounce } from 'lodash';\nimport { max as d3Max } from 'd3-array';\nimport { AsyncCreatableSelect, CreatableSelect } from 'src/components/Select';\nimport Button from 'src/components/Button';\nimport { t, SupersetClient } from '@superset-ui/core';\n\nimport {\n  BOOL_FALSE_DISPLAY,\n  BOOL_TRUE_DISPLAY,\n  SLOW_DEBOUNCE,\n} from 'src/constants';\nimport FormLabel from 'src/components/FormLabel';\nimport DateFilterControl from 'src/explore/components/controls/DateFilterControl';\nimport ControlRow from 'src/explore/components/ControlRow';\nimport Control from 'src/explore/components/Control';\nimport { controls } from 'src/explore/controls';\nimport { getExploreUrl } from 'src/explore/exploreUtils';\nimport OnPasteSelect from 'src/components/Select/OnPasteSelect';\nimport {\n  FILTER_CONFIG_ATTRIBUTES,\n  FILTER_OPTIONS_LIMIT,\n  TIME_FILTER_LABELS,\n  TIME_FILTER_MAP,\n} from 'src/explore/constants';\n\nimport './FilterBox.less';\n\n// a shortcut to a map key, used by many components\nexport const TIME_RANGE = TIME_FILTER_MAP.time_range;\n\nconst propTypes = {\n  chartId: PropTypes.number.isRequired,\n  origSelectedValues: PropTypes.object,\n  datasource: PropTypes.object.isRequired,\n  instantFiltering: PropTypes.bool,\n  filtersFields: PropTypes.arrayOf(\n    PropTypes.shape({\n      field: PropTypes.string,\n      label: PropTypes.string,\n    }),\n  ),\n  filtersChoices: PropTypes.objectOf(\n    PropTypes.arrayOf(\n      PropTypes.shape({\n        id: PropTypes.string,\n        text: PropTypes.string,\n        filter: PropTypes.string,\n        metric: PropTypes.number,\n      }),\n    ),\n  ),\n  onChange: PropTypes.func,\n  onFilterMenuOpen: PropTypes.func,\n  onFilterMenuClose: PropTypes.func,\n  showDateFilter: PropTypes.bool,\n  showSqlaTimeGrain: PropTypes.bool,\n  showSqlaTimeColumn: PropTypes.bool,\n  showDruidTimeGrain: PropTypes.bool,\n  showDruidTimeOrigin: PropTypes.bool,\n};\nconst defaultProps = {\n  origSelectedValues: {},\n  onChange: () => {},\n  onFilterMenuOpen: () => {},\n  onFilterMenuClose: () => {},\n  showDateFilter: false,\n  showSqlaTimeGrain: false,\n  showSqlaTimeColumn: false,\n  showDruidTimeGrain: false,\n  showDruidTimeOrigin: false,\n  instantFiltering: false,\n};\n\nclass FilterBox extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      selectedValues: props.origSelectedValues,\n      // this flag is used by non-instant filter, to make the apply button enabled/disabled\n      hasChanged: false,\n    };\n    this.debouncerCache = {};\n    this.maxValueCache = {};\n    this.changeFilter = this.changeFilter.bind(this);\n    this.onFilterMenuOpen = this.onFilterMenuOpen.bind(this);\n    this.onOpenDateFilterControl = this.onOpenDateFilterControl.bind(this);\n    this.onFilterMenuClose = this.onFilterMenuClose.bind(this);\n  }\n\n  onFilterMenuOpen(column) {\n    return this.props.onFilterMenuOpen(this.props.chartId, column);\n  }\n\n  onFilterMenuClose(column) {\n    return this.props.onFilterMenuClose(this.props.chartId, column);\n  }\n\n  onOpenDateFilterControl() {\n    return this.onFilterMenuOpen(TIME_RANGE);\n  }\n\n  onCloseDateFilterControl = () => this.onFilterMenuClose(TIME_RANGE);\n\n  getControlData(controlName) {\n    const { selectedValues } = this.state;\n    const control = {\n      ...controls[controlName], // TODO: make these controls ('druid_time_origin', 'granularity', 'granularity_sqla', 'time_grain_sqla') accessible from getControlsForVizType.\n      name: controlName,\n      key: `control-${controlName}`,\n      value: selectedValues[TIME_FILTER_MAP[controlName]],\n      actions: { setControlValue: this.changeFilter },\n    };\n    const mapFunc = control.mapStateToProps;\n    return mapFunc ? { ...control, ...mapFunc(this.props) } : control;\n  }\n\n  /**\n   * Get known max value of a column\n   */\n  getKnownMax(key, choices) {\n    this.maxValueCache[key] = Math.max(\n      this.maxValueCache[key] || 0,\n      d3Max(choices || this.props.filtersChoices[key] || [], x => x.metric),\n    );\n    return this.maxValueCache[key];\n  }\n\n  clickApply() {\n    const { selectedValues } = this.state;\n    this.setState({ hasChanged: false }, () => {\n      this.props.onChange(selectedValues, false);\n    });\n  }\n\n  changeFilter(filter, options) {\n    const fltr = TIME_FILTER_MAP[filter] || filter;\n    let vals = null;\n    if (options !== null) {\n      if (Array.isArray(options)) {\n        vals = options.map(opt => (typeof opt === 'string' ? opt : opt.value));\n      } else if (options.value) {\n        vals = options.value;\n      } else {\n        vals = options;\n      }\n    }\n\n    this.setState(\n      prevState => ({\n        selectedValues: {\n          ...prevState.selectedValues,\n          [fltr]: vals,\n        },\n        hasChanged: true,\n      }),\n      () => {\n        if (this.props.instantFiltering) {\n          this.props.onChange({ [fltr]: vals }, false);\n        }\n      },\n    );\n  }\n\n  /**\n   * Generate a debounce function that loads options for a specific column\n   */\n  debounceLoadOptions(key) {\n    if (!(key in this.debouncerCache)) {\n      this.debouncerCache[key] = debounce((input, callback) => {\n        this.loadOptions(key, input).then(callback);\n      }, SLOW_DEBOUNCE);\n    }\n    return this.debouncerCache[key];\n  }\n\n  /**\n   * Transform select options, add bar background\n   */\n  transformOptions(options, max) {\n    const maxValue = max === undefined ? d3Max(options, x => x.metric) : max;\n    return options.map(opt => {\n      const perc = Math.round((opt.metric / maxValue) * 100);\n      const color = 'lightgrey';\n      const backgroundImage = `linear-gradient(to right, ${color}, ${color} ${perc}%, rgba(0,0,0,0) ${perc}%`;\n      const style = { backgroundImage };\n      let label = opt.id;\n      if (label === true) {\n        label = BOOL_TRUE_DISPLAY;\n      } else if (label === false) {\n        label = BOOL_FALSE_DISPLAY;\n      }\n      return { value: opt.id, label, style };\n    });\n  }\n\n  async loadOptions(key, inputValue = '') {\n    const input = inputValue.toLowerCase();\n    const sortAsc = this.props.filtersFields.find(x => x.key === key).asc;\n    const formData = {\n      ...this.props.rawFormData,\n      adhoc_filters: inputValue\n        ? [\n            {\n              clause: 'WHERE',\n              comparator: null,\n              expressionType: 'SQL',\n              // TODO: Evaluate SQL Injection risk\n              sqlExpression: `lower(${key}) like '%${input}%'`,\n            },\n          ]\n        : null,\n    };\n\n    const { json } = await SupersetClient.get({\n      url: getExploreUrl({\n        formData,\n        endpointType: 'json',\n        method: 'GET',\n      }),\n    });\n    const options = (json?.data?.[key] || []).filter(x => x.id);\n    if (!options || options.length === 0) {\n      return [];\n    }\n    if (input) {\n      // sort those starts with search query to front\n      options.sort((a, b) => {\n        const labelA = a.id.toLowerCase();\n        const labelB = b.id.toLowerCase();\n        const textOrder = labelB.startsWith(input) - labelA.startsWith(input);\n        return textOrder === 0\n          ? (a.metric - b.metric) * (sortAsc ? 1 : -1)\n          : textOrder;\n      });\n    }\n    return this.transformOptions(options, this.getKnownMax(key, options));\n  }\n\n  renderDateFilter() {\n    const { showDateFilter } = this.props;\n    const label = TIME_FILTER_LABELS.time_range;\n    if (showDateFilter) {\n      return (\n        <div className=\"row space-1\">\n          <div\n            className=\"col-lg-12 col-xs-12\"\n            data-test=\"date-filter-container\"\n          >\n            <DateFilterControl\n              name={TIME_RANGE}\n              label={label}\n              description={t('Select start and end date')}\n              onChange={newValue => {\n                this.changeFilter(TIME_RANGE, newValue);\n              }}\n              onOpenDateFilterControl={this.onOpenDateFilterControl}\n              onCloseDateFilterControl={this.onCloseDateFilterControl}\n              value={this.state.selectedValues[TIME_RANGE] || 'No filter'}\n            />\n          </div>\n        </div>\n      );\n    }\n    return null;\n  }\n\n  renderDatasourceFilters() {\n    const {\n      showSqlaTimeGrain,\n      showSqlaTimeColumn,\n      showDruidTimeGrain,\n      showDruidTimeOrigin,\n    } = this.props;\n    const datasourceFilters = [];\n    const sqlaFilters = [];\n    const druidFilters = [];\n    if (showSqlaTimeGrain) sqlaFilters.push('time_grain_sqla');\n    if (showSqlaTimeColumn) sqlaFilters.push('granularity_sqla');\n    if (showDruidTimeGrain) druidFilters.push('granularity');\n    if (showDruidTimeOrigin) druidFilters.push('druid_time_origin');\n    if (sqlaFilters.length) {\n      datasourceFilters.push(\n        <ControlRow\n          key=\"sqla-filters\"\n          controls={sqlaFilters.map(control => (\n            <Control {...this.getControlData(control)} />\n          ))}\n        />,\n      );\n    }\n    if (druidFilters.length) {\n      datasourceFilters.push(\n        <ControlRow\n          key=\"druid-filters\"\n          controls={druidFilters.map(control => (\n            <Control {...this.getControlData(control)} />\n          ))}\n        />,\n      );\n    }\n    return datasourceFilters;\n  }\n\n  renderSelect(filterConfig) {\n    const { filtersChoices } = this.props;\n    const { selectedValues } = this.state;\n    this.debouncerCache = {};\n    this.maxValueCache = {};\n\n    // Add created options to filtersChoices, even though it doesn't exist,\n    // or these options will exist in query sql but invisible to end user.\n    Object.keys(selectedValues)\n      .filter(key => key in filtersChoices)\n      .forEach(key => {\n        // empty values are ignored\n        if (!selectedValues[key]) {\n          return;\n        }\n        const choices = filtersChoices[key] || (filtersChoices[key] = []);\n        const choiceIds = new Set(choices.map(f => f.id));\n        const selectedValuesForKey = Array.isArray(selectedValues[key])\n          ? selectedValues[key]\n          : [selectedValues[key]];\n        selectedValuesForKey\n          .filter(value => value !== null && !choiceIds.has(value))\n          .forEach(value => {\n            choices.unshift({\n              filter: key,\n              id: value,\n              text: value,\n              metric: 0,\n            });\n          });\n      });\n    const {\n      key,\n      label,\n      [FILTER_CONFIG_ATTRIBUTES.MULTIPLE]: isMultiple,\n      [FILTER_CONFIG_ATTRIBUTES.DEFAULT_VALUE]: defaultValue,\n      [FILTER_CONFIG_ATTRIBUTES.CLEARABLE]: isClearable,\n      [FILTER_CONFIG_ATTRIBUTES.SEARCH_ALL_OPTIONS]: searchAllOptions,\n    } = filterConfig;\n    const data = filtersChoices[key] || [];\n    let value = selectedValues[key] || null;\n\n    // Assign default value if required\n    if (value === undefined && defaultValue) {\n      // multiple values are separated by semicolons\n      value = isMultiple ? defaultValue.split(';') : defaultValue;\n    }\n\n    return (\n      <OnPasteSelect\n        cacheOptions\n        loadOptions={this.debounceLoadOptions(key)}\n        defaultOptions={this.transformOptions(data)}\n        key={key}\n        placeholder={t('Type or Select [%s]', label)}\n        isMulti={isMultiple}\n        isClearable={isClearable}\n        value={value}\n        options={this.transformOptions(data)}\n        onChange={newValue => {\n          // avoid excessive re-renders\n          if (newValue !== value) {\n            this.changeFilter(key, newValue);\n          }\n        }}\n        // TODO try putting this back once react-select is upgraded\n        // onFocus={() => this.onFilterMenuOpen(key)}\n        onMenuOpen={() => this.onFilterMenuOpen(key)}\n        onBlur={() => this.onFilterMenuClose(key)}\n        onMenuClose={() => this.onFilterMenuClose(key)}\n        selectWrap={\n          searchAllOptions && data.length >= FILTER_OPTIONS_LIMIT\n            ? AsyncCreatableSelect\n            : CreatableSelect\n        }\n        noResultsText={t('No results found')}\n        forceOverflow\n      />\n    );\n  }\n\n  renderFilters() {\n    const { filtersFields = [] } = this.props;\n    return filtersFields.map(filterConfig => {\n      const { label, key } = filterConfig;\n      return (\n        <div key={key} className=\"m-b-5 filter-container\">\n          <FormLabel htmlFor={`LABEL-${key}`}>{label}</FormLabel>\n          {this.renderSelect(filterConfig)}\n        </div>\n      );\n    });\n  }\n\n  render() {\n    const { instantFiltering, width, height } = this.props;\n    return (\n      <div style={{ width, height, overflow: 'auto' }}>\n        {this.renderDateFilter()}\n        {this.renderDatasourceFilters()}\n        {this.renderFilters()}\n        {!instantFiltering && (\n          <Button\n            buttonSize=\"small\"\n            buttonStyle=\"primary\"\n            onClick={this.clickApply.bind(this)}\n            disabled={!this.state.hasChanged}\n          >\n            {t('Apply')}\n          </Button>\n        )}\n      </div>\n    );\n  }\n}\n\nFilterBox.propTypes = propTypes;\nFilterBox.defaultProps = defaultProps;\n\nexport default FilterBox;\n"]},"metadata":{},"sourceType":"module"}