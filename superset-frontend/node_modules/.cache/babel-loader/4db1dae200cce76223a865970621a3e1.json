{"ast":null,"code":"import \"core-js/modules/web.dom-collections.iterator.js\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";import _Object$keys from \"@babel/runtime-corejs3/core-js-stable/object/keys\";import _Object$values from \"@babel/runtime-corejs3/core-js-stable/object/values\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable no-param-reassign */\nimport { styled, t } from '@superset-ui/core';\nimport React, { useMemo, useState } from 'react';\nimport { useDispatch } from 'react-redux';\nimport cx from 'classnames';\nimport Icon from 'src/components/Icon';\nimport { Tabs } from 'src/common/components';\nimport { FeatureFlag, isFeatureEnabled } from 'src/featureFlags';\nimport { updateDataMask } from 'src/dataMask/actions';\nimport { useImmer } from 'use-immer';\nimport { areObjectsEqual } from 'src/reduxUtils';\nimport { mapParentFiltersToChildren, TabIds } from './utils';\nimport FilterSets from './FilterSets/FilterSets';\nimport { useDataMask, useFilters, useFilterSets, useFiltersInitialisation, useFilterUpdates } from './state';\nimport EditSection from './FilterSets/EditSection';\nimport Header from './Header';\nimport FilterControls from './FilterControls/FilterControls';import { jsx as ___EmotionJSX } from \"@emotion/core\";\nconst barWidth = `250px`;\nconst BarWrapper = styled.div`\n  width: ${({ theme }) => theme.gridUnit * 8}px;\n  & .ant-tabs-top > .ant-tabs-nav {\n    margin: 0;\n  }\n  &.open {\n    width: ${barWidth}; // arbitrary...\n  }\n`;\nconst Bar = styled.div`\n  & .ant-typography-edit-content {\n    left: 0;\n    margin-top: 0;\n    width: 100%;\n  }\n  position: absolute;\n  top: 0;\n  left: 0;\n  flex-direction: column;\n  flex-grow: 1;\n  width: ${barWidth}; // arbitrary...\n  background: ${({ theme }) => theme.colors.grayscale.light5};\n  border-right: 1px solid ${({ theme }) => theme.colors.grayscale.light2};\n  min-height: 100%;\n  display: none;\n  /* &.animated {\n    display: flex;\n    transform: translateX(-100%);\n    transition: transform ${({ theme }) => theme.transitionTiming}s;\n    transition-delay: 0s;\n  }  */\n\n  &.open {\n    display: flex;\n    /* &.animated {\n      transform: translateX(0);\n      transition-delay: ${({ theme }) => theme.transitionTiming * 2}s;\n    } */\n  }\n`;\nconst CollapsedBar = styled.div`\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  width: ${({ theme }) => theme.gridUnit * 8}px;\n  padding-top: ${({ theme }) => theme.gridUnit * 2}px;\n  display: none;\n  text-align: center;\n  /* &.animated {\n    display: block;\n    transform: translateX(-100%);\n    transition: transform ${({ theme }) => theme.transitionTiming}s;\n    transition-delay: 0s;\n  } */\n\n  &.open {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: ${({ theme }) => theme.gridUnit * 2}px;\n    /* &.animated {\n      transform: translateX(0);\n      transition-delay: ${({ theme }) => theme.transitionTiming * 3}s;\n    } */\n  }\n\n  svg {\n    width: ${({ theme }) => theme.gridUnit * 4}px;\n    height: ${({ theme }) => theme.gridUnit * 4}px;\n    cursor: pointer;\n  }\n`;\nconst StyledCollapseIcon = styled(Icon)`\n  color: ${({ theme }) => theme.colors.primary.base};\n  margin-bottom: ${({ theme }) => theme.gridUnit * 3}px;\n`;\nconst StyledTabs = styled(Tabs)`\n  & .ant-tabs-nav-list {\n    width: 100%;\n  }\n  & .ant-tabs-tab {\n    display: flex;\n    justify-content: center;\n    margin: 0;\n    flex: 1;\n  }\n`;\nconst FilterBar = ({ filtersOpen, toggleFiltersBar, directPathToChild }) => {\n  const [editFilterSetId, setEditFilterSetId] = useState(null);\n  const [dataMaskSelected, setDataMaskSelected] = useImmer({});\n  const [lastAppliedFilterData, setLastAppliedFilterData] = useImmer({});\n  const dispatch = useDispatch();\n  const filterSets = useFilterSets();\n  const filterSetFilterValues = _Object$values(filterSets);\n  const [tab, setTab] = useState(TabIds.AllFilters);\n  const filters = useFilters();\n  const filterValues = _Object$values(filters);\n  const dataMaskApplied = useDataMask();\n  const [isFilterSetChanged, setIsFilterSetChanged] = useState(false);\n  const cascadeChildren = useMemo(() => mapParentFiltersToChildren(filterValues), [filterValues]);\n  const handleFilterSelectionChange = (filter, dataMask) => {\n    setIsFilterSetChanged(tab !== TabIds.AllFilters);\n    setDataMaskSelected(draft => {\n      const children = cascadeChildren[filter.id] || [];\n      // force instant updating on initialization or for parent filters\n      if (filter.isInstant || children.length > 0) {\n        dispatch(updateDataMask(filter.id, dataMask));\n      }\n      if (dataMask.nativeFilters) {\n        draft[filter.id] = dataMask.nativeFilters;\n      }\n    });\n  };\n  const handleApply = () => {\n    const filterIds = _Object$keys(dataMaskSelected);\n    _forEachInstanceProperty(filterIds).call(filterIds, filterId => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(updateDataMask(filterId, {\n          nativeFilters: dataMaskSelected[filterId] }));\n\n      }\n    });\n    setLastAppliedFilterData(() => dataMaskSelected);\n  };\n  const { isInitialized } = useFiltersInitialisation(dataMaskSelected, handleApply);\n  useFilterUpdates(dataMaskSelected, setDataMaskSelected, setLastAppliedFilterData);\n  const isApplyDisabled = !isInitialized || areObjectsEqual(dataMaskSelected, lastAppliedFilterData);\n  return ___EmotionJSX(BarWrapper, { \"data-test\": \"filter-bar\", className: cx({ open: filtersOpen }) },\n  ___EmotionJSX(CollapsedBar, { className: cx({ open: !filtersOpen }), onClick: () => toggleFiltersBar(true) },\n  ___EmotionJSX(StyledCollapseIcon, { name: \"collapse\" }),\n  ___EmotionJSX(Icon, { name: \"filter\" })),\n\n  ___EmotionJSX(Bar, { className: cx({ open: filtersOpen }) },\n  ___EmotionJSX(Header, { toggleFiltersBar: toggleFiltersBar, onApply: handleApply, setDataMaskSelected: setDataMaskSelected, isApplyDisabled: isApplyDisabled, dataMaskSelected: dataMaskSelected, dataMaskApplied: dataMaskApplied }),\n  isFeatureEnabled(FeatureFlag.DASHBOARD_NATIVE_FILTERS_SET) ? ___EmotionJSX(StyledTabs, { centered: true, onChange: setTab, defaultActiveKey: TabIds.AllFilters, activeKey: editFilterSetId ? TabIds.AllFilters : undefined },\n  ___EmotionJSX(Tabs.TabPane, { tab: t(`All Filters (${filterValues.length})`), key: TabIds.AllFilters },\n  editFilterSetId && ___EmotionJSX(EditSection, { dataMaskSelected: dataMaskSelected, disabled: !isApplyDisabled, onCancel: () => setEditFilterSetId(null), filterSetId: editFilterSetId }),\n  ___EmotionJSX(FilterControls, { dataMaskSelected: dataMaskSelected, directPathToChild: directPathToChild, onFilterSelectionChange: handleFilterSelectionChange })),\n\n  ___EmotionJSX(Tabs.TabPane, { disabled: !!editFilterSetId, tab: t(`Filter Sets (${filterSetFilterValues.length})`), key: TabIds.FilterSets },\n  ___EmotionJSX(FilterSets, { onEditFilterSet: setEditFilterSetId, disabled: !isApplyDisabled, dataMaskSelected: dataMaskSelected, isFilterSetChanged: isFilterSetChanged, onFilterSelectionChange: handleFilterSelectionChange }))) :\n\n  ___EmotionJSX(FilterControls, { dataMaskSelected: dataMaskSelected, directPathToChild: directPathToChild, onFilterSelectionChange: handleFilterSelectionChange })));\n\n\n};__signature__(FilterBar, \"useState{[editFilterSetId, setEditFilterSetId](null)}\\nuseImmer{[dataMaskSelected, setDataMaskSelected]}\\nuseImmer{[lastAppliedFilterData, setLastAppliedFilterData,]}\\nuseDispatch{dispatch}\\nuseFilterSets{filterSets}\\nuseState{[tab, setTab](TabIds.AllFilters)}\\nuseFilters{filters}\\nuseDataMask{dataMaskApplied}\\nuseState{[isFilterSetChanged, setIsFilterSetChanged](false)}\\nuseMemo{cascadeChildren}\\nuseFiltersInitialisation{{ isInitialized }}\\nuseFilterUpdates{}\", () => [useImmer, useImmer, useDispatch, useFilterSets, useFilters, useDataMask, useFiltersInitialisation, useFilterUpdates]);const _default =\nFilterBar;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(barWidth, \"barWidth\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(BarWrapper, \"BarWrapper\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(Bar, \"Bar\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(CollapsedBar, \"CollapsedBar\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(StyledCollapseIcon, \"StyledCollapseIcon\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(StyledTabs, \"StyledTabs\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(FilterBar, \"FilterBar\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterBar.tsx"],"names":[],"mappings":"8lBAAA;;;;;;;;;;;;;;;;;AAiBG;AAEH;AACA,SAA0B,MAA1B,EAAkC,CAAlC,QAA2C,mBAA3C;AACA,OAAO,KAAP,IAAgB,OAAhB,EAAyB,QAAzB,QAAyC,OAAzC;AACA,SAAS,WAAT,QAA4B,aAA5B;AACA,OAAO,EAAP,MAAe,YAAf;AACA,OAAO,IAAP,MAAiB,qBAAjB;AACA,SAAS,IAAT,QAAqB,uBAArB;AACA,SAAS,WAAT,EAAsB,gBAAtB,QAA8C,kBAA9C;AACA,SAAS,cAAT,QAA+B,sBAA/B;AAEA,SAAS,QAAT,QAAyB,WAAzB;AACA,SAAS,eAAT,QAAgC,gBAAhC;AAEA,SAAS,0BAAT,EAAqC,MAArC,QAAmD,SAAnD;AACA,OAAO,UAAP,MAAuB,yBAAvB;AACA,SACE,WADF,EAEE,UAFF,EAGE,aAHF,EAIE,wBAJF,EAKE,gBALF,QAMO,SANP;AAOA,OAAO,WAAP,MAAwB,0BAAxB;AACA,OAAO,MAAP,MAAmB,UAAnB;AACA,OAAO,cAAP,MAA2B,iCAA3B,C;AAEA,MAAM,QAAQ,GAAG,OAAjB;AAEA,MAAM,UAAU,GAAG,MAAM,CAAC,GAAG;WAClB,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;;;;;aAK/B,QAAQ;;AAEpB,CARD;AAUA,MAAM,GAAG,GAAG,MAAM,CAAC,GAAG;;;;;;;;;;;WAWX,QAAQ;gBACH,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,MAAN,CAAa,SAAb,CAAuB,MAAM;4BAChC,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,MAAN,CAAa,SAAb,CAAuB,MAAM;;;;;;4BAM5C,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,gBAAgB;;;;;;;;0BAQvC,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,gBAAN,GAAyB,CAAC;;;AAGlE,CA9BD;AAgCA,MAAM,YAAY,GAAG,MAAM,CAAC,GAAG;;;;;WAKpB,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;iBAC3B,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;;;;;;4BAMtB,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,gBAAgB;;;;;;;;eAQlD,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;;;0BAGtB,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,gBAAN,GAAyB,CAAC;;;;;aAKtD,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;cAChC,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;;;AAG9C,CAhCD;AAkCA,MAAM,kBAAkB,GAAG,MAAM,CAAC,IAAD,CAAM;WAC5B,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,MAAN,CAAa,OAAb,CAAqB,IAAI;mBAChC,CAAC,EAAE,KAAF,EAAD,KAAe,KAAK,CAAC,QAAN,GAAiB,CAAC;AACnD,CAHD;AAKA,MAAM,UAAU,GAAG,MAAM,CAAC,IAAD,CAAM;;;;;;;;;;AAU9B,CAVD;AAkBA,MAAM,SAAS,GAA8B,CAAC,EAC5C,WAD4C,EAE5C,gBAF4C,EAG5C,iBAH4C,EAAD,KAIxC;AACH,QAAM,CAAC,eAAD,EAAkB,kBAAlB,IAAwC,QAAQ,CAAgB,IAAhB,CAAtD;AACA,QAAM,CAAC,gBAAD,EAAmB,mBAAnB,IAA0C,QAAQ,CAAe,EAAf,CAAxD;AACA,QAAM,CACJ,qBADI,EAEJ,wBAFI,IAGF,QAAQ,CAAe,EAAf,CAHZ;AAIA,QAAM,QAAQ,GAAG,WAAW,EAA5B;AACA,QAAM,UAAU,GAAG,aAAa,EAAhC;AACA,QAAM,qBAAqB,GAAG,eAAc,UAAd,CAA9B;AACA,QAAM,CAAC,GAAD,EAAM,MAAN,IAAgB,QAAQ,CAAC,MAAM,CAAC,UAAR,CAA9B;AACA,QAAM,OAAO,GAAG,UAAU,EAA1B;AACA,QAAM,YAAY,GAAG,eAAsB,OAAtB,CAArB;AACA,QAAM,eAAe,GAAG,WAAW,EAAnC;AACA,QAAM,CAAC,kBAAD,EAAqB,qBAArB,IAA8C,QAAQ,CAAC,KAAD,CAA5D;AAEA,QAAM,eAAe,GAAG,OAAO,CAC7B,MAAM,0BAA0B,CAAC,YAAD,CADH,EAE7B,CAAC,YAAD,CAF6B,CAA/B;AAKA,QAAM,2BAA2B,GAAG,CAClC,MADkC,EAElC,QAFkC,KAGhC;AACF,IAAA,qBAAqB,CAAC,GAAG,KAAK,MAAM,CAAC,UAAhB,CAArB;AACA,IAAA,mBAAmB,CAAC,KAAK,IAAG;AAC1B,YAAM,QAAQ,GAAG,eAAe,CAAC,MAAM,CAAC,EAAR,CAAf,IAA8B,EAA/C;AACA;AACA,UAAI,MAAM,CAAC,SAAP,IAAoB,QAAQ,CAAC,MAAT,GAAkB,CAA1C,EAA6C;AAC3C,QAAA,QAAQ,CAAC,cAAc,CAAC,MAAM,CAAC,EAAR,EAAY,QAAZ,CAAf,CAAR;AACD;AAED,UAAI,QAAQ,CAAC,aAAb,EAA4B;AAC1B,QAAA,KAAK,CAAC,MAAM,CAAC,EAAR,CAAL,GAAmB,QAAQ,CAAC,aAA5B;AACD;AACF,KAVkB,CAAnB;AAWD,GAhBD;AAkBA,QAAM,WAAW,GAAG,MAAK;AACvB,UAAM,SAAS,GAAG,aAAY,gBAAZ,CAAlB;AACA,6BAAA,SAAS,MAAT,CAAA,SAAS,EAAS,QAAQ,IAAG;AAC3B,UAAI,gBAAgB,CAAC,QAAD,CAApB,EAAgC;AAC9B,QAAA,QAAQ,CACN,cAAc,CAAC,QAAD,EAAW;AACvB,UAAA,aAAa,EAAE,gBAAgB,CAAC,QAAD,CADR,EAAX,CADR,CAAR;;AAKD;AACF,KARQ,CAAT;AASA,IAAA,wBAAwB,CAAC,MAAM,gBAAP,CAAxB;AACD,GAZD;AAcA,QAAM,EAAE,aAAF,KAAoB,wBAAwB,CAChD,gBADgD,EAEhD,WAFgD,CAAlD;AAKA,EAAA,gBAAgB,CACd,gBADc,EAEd,mBAFc,EAGd,wBAHc,CAAhB;AAMA,QAAM,eAAe,GACnB,CAAC,aAAD,IAAkB,eAAe,CAAC,gBAAD,EAAmB,qBAAnB,CADnC;AAGA,SACE,cAAC,UAAD,IAAY,aAAU,YAAtB,EAAmC,SAAS,EAAE,EAAE,CAAC,EAAE,IAAI,EAAE,WAAR,EAAD,CAAhD;AACE,gBAAC,YAAD,IACE,SAAS,EAAE,EAAE,CAAC,EAAE,IAAI,EAAE,CAAC,WAAT,EAAD,CADf,EAEE,OAAO,EAAE,MAAM,gBAAgB,CAAC,IAAD,CAFjC;AAIE,gBAAC,kBAAD,IAAoB,IAAI,EAAC,UAAzB,GAJF;AAKE,gBAAC,IAAD,IAAM,IAAI,EAAC,QAAX,GALF,CADF;;AAQE,gBAAC,GAAD,IAAK,SAAS,EAAE,EAAE,CAAC,EAAE,IAAI,EAAE,WAAR,EAAD,CAAlB;AACE,gBAAC,MAAD,IACE,gBAAgB,EAAE,gBADpB,EAEE,OAAO,EAAE,WAFX,EAGE,mBAAmB,EAAE,mBAHvB,EAIE,eAAe,EAAE,eAJnB,EAKE,gBAAgB,EAAE,gBALpB,EAME,eAAe,EAAE,eANnB,GADF;AASG,EAAA,gBAAgB,CAAC,WAAW,CAAC,4BAAb,CAAhB,GACC,cAAC,UAAD,IACE,QAAQ,MADV,EAEE,QAAQ,EAAE,MAFZ,EAGE,gBAAgB,EAAE,MAAM,CAAC,UAH3B,EAIE,SAAS,EAAE,eAAe,GAAG,MAAM,CAAC,UAAV,GAAuB,SAJnD;AAME,gBAAC,IAAD,CAAM,OAAN,IACE,GAAG,EAAE,CAAC,CAAC,gBAAgB,YAAY,CAAC,MAAM,GAApC,CADR,EAEE,GAAG,EAAE,MAAM,CAAC,UAFd;AAIG,EAAA,eAAe,IACd,cAAC,WAAD,IACE,gBAAgB,EAAE,gBADpB,EAEE,QAAQ,EAAE,CAAC,eAFb,EAGE,QAAQ,EAAE,MAAM,kBAAkB,CAAC,IAAD,CAHpC,EAIE,WAAW,EAAE,eAJf,GALJ;AAYE,gBAAC,cAAD,IACE,gBAAgB,EAAE,gBADpB,EAEE,iBAAiB,EAAE,iBAFrB,EAGE,uBAAuB,EAAE,2BAH3B,GAZF,CANF;;AAwBE,gBAAC,IAAD,CAAM,OAAN,IACE,QAAQ,EAAE,CAAC,CAAC,eADd,EAEE,GAAG,EAAE,CAAC,CAAC,gBAAgB,qBAAqB,CAAC,MAAM,GAA7C,CAFR,EAGE,GAAG,EAAE,MAAM,CAAC,UAHd;AAKE,gBAAC,UAAD,IACE,eAAe,EAAE,kBADnB,EAEE,QAAQ,EAAE,CAAC,eAFb,EAGE,gBAAgB,EAAE,gBAHpB,EAIE,kBAAkB,EAAE,kBAJtB,EAKE,uBAAuB,EAAE,2BAL3B,GALF,CAxBF,CADD;;AAwCC,gBAAC,cAAD,IACE,gBAAgB,EAAE,gBADpB,EAEE,iBAAiB,EAAE,iBAFrB,EAGE,uBAAuB,EAAE,2BAH3B,GAjDJ,CARF,CADF;;;AAmED,CA1ID,C,cAAM,S,6dAM4C,Q,EAI5C,Q,EACa,W,EACE,a,EAGH,U,EAEQ,W,EAwCE,wB,EAK1B,gB;AA8Ea,S,CAAf,wB,iLAjPM,Q,+HAEA,U,iIAUA,G,0HAgCA,Y,mIAkCA,kB,yIAKA,U,iIAkBA,S","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\n/* eslint-disable no-param-reassign */\nimport { HandlerFunction, styled, t } from '@superset-ui/core';\nimport React, { useMemo, useState } from 'react';\nimport { useDispatch } from 'react-redux';\nimport cx from 'classnames';\nimport Icon from 'src/components/Icon';\nimport { Tabs } from 'src/common/components';\nimport { FeatureFlag, isFeatureEnabled } from 'src/featureFlags';\nimport { updateDataMask } from 'src/dataMask/actions';\nimport { DataMaskState, DataMaskUnit } from 'src/dataMask/types';\nimport { useImmer } from 'use-immer';\nimport { areObjectsEqual } from 'src/reduxUtils';\nimport { Filter } from '../types';\nimport { mapParentFiltersToChildren, TabIds } from './utils';\nimport FilterSets from './FilterSets/FilterSets';\nimport {\n  useDataMask,\n  useFilters,\n  useFilterSets,\n  useFiltersInitialisation,\n  useFilterUpdates,\n} from './state';\nimport EditSection from './FilterSets/EditSection';\nimport Header from './Header';\nimport FilterControls from './FilterControls/FilterControls';\n\nconst barWidth = `250px`;\n\nconst BarWrapper = styled.div`\n  width: ${({ theme }) => theme.gridUnit * 8}px;\n  & .ant-tabs-top > .ant-tabs-nav {\n    margin: 0;\n  }\n  &.open {\n    width: ${barWidth}; // arbitrary...\n  }\n`;\n\nconst Bar = styled.div`\n  & .ant-typography-edit-content {\n    left: 0;\n    margin-top: 0;\n    width: 100%;\n  }\n  position: absolute;\n  top: 0;\n  left: 0;\n  flex-direction: column;\n  flex-grow: 1;\n  width: ${barWidth}; // arbitrary...\n  background: ${({ theme }) => theme.colors.grayscale.light5};\n  border-right: 1px solid ${({ theme }) => theme.colors.grayscale.light2};\n  min-height: 100%;\n  display: none;\n  /* &.animated {\n    display: flex;\n    transform: translateX(-100%);\n    transition: transform ${({ theme }) => theme.transitionTiming}s;\n    transition-delay: 0s;\n  }  */\n\n  &.open {\n    display: flex;\n    /* &.animated {\n      transform: translateX(0);\n      transition-delay: ${({ theme }) => theme.transitionTiming * 2}s;\n    } */\n  }\n`;\n\nconst CollapsedBar = styled.div`\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  width: ${({ theme }) => theme.gridUnit * 8}px;\n  padding-top: ${({ theme }) => theme.gridUnit * 2}px;\n  display: none;\n  text-align: center;\n  /* &.animated {\n    display: block;\n    transform: translateX(-100%);\n    transition: transform ${({ theme }) => theme.transitionTiming}s;\n    transition-delay: 0s;\n  } */\n\n  &.open {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: ${({ theme }) => theme.gridUnit * 2}px;\n    /* &.animated {\n      transform: translateX(0);\n      transition-delay: ${({ theme }) => theme.transitionTiming * 3}s;\n    } */\n  }\n\n  svg {\n    width: ${({ theme }) => theme.gridUnit * 4}px;\n    height: ${({ theme }) => theme.gridUnit * 4}px;\n    cursor: pointer;\n  }\n`;\n\nconst StyledCollapseIcon = styled(Icon)`\n  color: ${({ theme }) => theme.colors.primary.base};\n  margin-bottom: ${({ theme }) => theme.gridUnit * 3}px;\n`;\n\nconst StyledTabs = styled(Tabs)`\n  & .ant-tabs-nav-list {\n    width: 100%;\n  }\n  & .ant-tabs-tab {\n    display: flex;\n    justify-content: center;\n    margin: 0;\n    flex: 1;\n  }\n`;\n\ninterface FiltersBarProps {\n  filtersOpen: boolean;\n  toggleFiltersBar: any;\n  directPathToChild?: string[];\n}\n\nconst FilterBar: React.FC<FiltersBarProps> = ({\n  filtersOpen,\n  toggleFiltersBar,\n  directPathToChild,\n}) => {\n  const [editFilterSetId, setEditFilterSetId] = useState<string | null>(null);\n  const [dataMaskSelected, setDataMaskSelected] = useImmer<DataMaskUnit>({});\n  const [\n    lastAppliedFilterData,\n    setLastAppliedFilterData,\n  ] = useImmer<DataMaskUnit>({});\n  const dispatch = useDispatch();\n  const filterSets = useFilterSets();\n  const filterSetFilterValues = Object.values(filterSets);\n  const [tab, setTab] = useState(TabIds.AllFilters);\n  const filters = useFilters();\n  const filterValues = Object.values<Filter>(filters);\n  const dataMaskApplied = useDataMask();\n  const [isFilterSetChanged, setIsFilterSetChanged] = useState(false);\n\n  const cascadeChildren = useMemo(\n    () => mapParentFiltersToChildren(filterValues),\n    [filterValues],\n  );\n\n  const handleFilterSelectionChange = (\n    filter: Pick<Filter, 'id'> & Partial<Filter>,\n    dataMask: Partial<DataMaskState>,\n  ) => {\n    setIsFilterSetChanged(tab !== TabIds.AllFilters);\n    setDataMaskSelected(draft => {\n      const children = cascadeChildren[filter.id] || [];\n      // force instant updating on initialization or for parent filters\n      if (filter.isInstant || children.length > 0) {\n        dispatch(updateDataMask(filter.id, dataMask));\n      }\n\n      if (dataMask.nativeFilters) {\n        draft[filter.id] = dataMask.nativeFilters;\n      }\n    });\n  };\n\n  const handleApply = () => {\n    const filterIds = Object.keys(dataMaskSelected);\n    filterIds.forEach(filterId => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(\n          updateDataMask(filterId, {\n            nativeFilters: dataMaskSelected[filterId],\n          }),\n        );\n      }\n    });\n    setLastAppliedFilterData(() => dataMaskSelected);\n  };\n\n  const { isInitialized } = useFiltersInitialisation(\n    dataMaskSelected,\n    handleApply,\n  );\n\n  useFilterUpdates(\n    dataMaskSelected,\n    setDataMaskSelected,\n    setLastAppliedFilterData,\n  );\n\n  const isApplyDisabled =\n    !isInitialized || areObjectsEqual(dataMaskSelected, lastAppliedFilterData);\n\n  return (\n    <BarWrapper data-test=\"filter-bar\" className={cx({ open: filtersOpen })}>\n      <CollapsedBar\n        className={cx({ open: !filtersOpen })}\n        onClick={() => toggleFiltersBar(true)}\n      >\n        <StyledCollapseIcon name=\"collapse\" />\n        <Icon name=\"filter\" />\n      </CollapsedBar>\n      <Bar className={cx({ open: filtersOpen })}>\n        <Header\n          toggleFiltersBar={toggleFiltersBar}\n          onApply={handleApply}\n          setDataMaskSelected={setDataMaskSelected}\n          isApplyDisabled={isApplyDisabled}\n          dataMaskSelected={dataMaskSelected}\n          dataMaskApplied={dataMaskApplied}\n        />\n        {isFeatureEnabled(FeatureFlag.DASHBOARD_NATIVE_FILTERS_SET) ? (\n          <StyledTabs\n            centered\n            onChange={setTab as HandlerFunction}\n            defaultActiveKey={TabIds.AllFilters}\n            activeKey={editFilterSetId ? TabIds.AllFilters : undefined}\n          >\n            <Tabs.TabPane\n              tab={t(`All Filters (${filterValues.length})`)}\n              key={TabIds.AllFilters}\n            >\n              {editFilterSetId && (\n                <EditSection\n                  dataMaskSelected={dataMaskSelected}\n                  disabled={!isApplyDisabled}\n                  onCancel={() => setEditFilterSetId(null)}\n                  filterSetId={editFilterSetId}\n                />\n              )}\n              <FilterControls\n                dataMaskSelected={dataMaskSelected}\n                directPathToChild={directPathToChild}\n                onFilterSelectionChange={handleFilterSelectionChange}\n              />\n            </Tabs.TabPane>\n            <Tabs.TabPane\n              disabled={!!editFilterSetId}\n              tab={t(`Filter Sets (${filterSetFilterValues.length})`)}\n              key={TabIds.FilterSets}\n            >\n              <FilterSets\n                onEditFilterSet={setEditFilterSetId}\n                disabled={!isApplyDisabled}\n                dataMaskSelected={dataMaskSelected}\n                isFilterSetChanged={isFilterSetChanged}\n                onFilterSelectionChange={handleFilterSelectionChange}\n              />\n            </Tabs.TabPane>\n          </StyledTabs>\n        ) : (\n          <FilterControls\n            dataMaskSelected={dataMaskSelected}\n            directPathToChild={directPathToChild}\n            onFilterSelectionChange={handleFilterSelectionChange}\n          />\n        )}\n      </Bar>\n    </BarWrapper>\n  );\n};\n\nexport default FilterBar;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}