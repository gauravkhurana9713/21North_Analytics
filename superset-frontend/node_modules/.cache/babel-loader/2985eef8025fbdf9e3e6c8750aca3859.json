{"ast":null,"code":"import _extends from \"@babel/runtime-corejs3/helpers/extends\";import _filterInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/filter\";import _indexOfInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/index-of\";import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _setTimeout from \"@babel/runtime-corejs3/core-js-stable/set-timeout\";import _findInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/find\";import _bindInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/bind\";import _Array$isArray from \"@babel/runtime-corejs3/core-js-stable/array/is-array\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable camelcase */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { FormGroup } from 'react-bootstrap';\nimport Tabs from 'src/common/components/Tabs';\nimport Button from 'src/components/Button';\nimport { NativeSelect as Select } from 'src/components/Select';\nimport { styled, t } from '@superset-ui/core';\nimport { ColumnOption, MetricOption } from '@superset-ui/chart-controls';\n\nimport FormLabel from 'src/components/FormLabel';\nimport { SQLEditor } from 'src/components/AsyncAceEditor';\nimport sqlKeywords from 'src/SqlLab/utils/sqlKeywords';\nimport { noOp } from 'src/utils/common';\n\nimport { AGGREGATES_OPTIONS } from 'src/explore/constants';\nimport columnType from './columnType';\nimport savedMetricType from './savedMetricType';\nimport AdhocMetric, { EXPRESSION_TYPES } from './AdhocMetric';import { jsx as ___EmotionJSX } from \"@emotion/core\";\n\nconst propTypes = {\n  adhocMetric: PropTypes.instanceOf(AdhocMetric).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  getCurrentTab: PropTypes.func,\n  getCurrentLabel: PropTypes.func,\n  columns: PropTypes.arrayOf(columnType),\n  savedMetricsOptions: PropTypes.arrayOf(savedMetricType),\n  savedMetric: savedMetricType,\n  datasourceType: PropTypes.string };\n\n\nconst defaultProps = {\n  columns: [],\n  getCurrentTab: noOp };\n\n\nconst ResizeIcon = styled.i`\n  margin-left: ${({ theme }) => theme.gridUnit * 2}px;\n`;\n\nconst ColumnOptionStyle = styled.span`\n  .option-label {\n    display: inline;\n  }\n`;\n\nexport const SAVED_TAB_KEY = 'SAVED';\n\nconst startingWidth = 320;\nconst startingHeight = 240;\n\nexport default class AdhocMetricEditPopover extends React.PureComponent {\n  // \"Saved\" is a default tab unless there are no saved metrics for dataset\n\n\n\n\n\n\n\n  constructor(props) {var _context, _context2, _context3, _context4, _context5, _context6, _context7, _context8, _context9, _context10, _context11, _context12;\n    super(props);this.defaultActiveTabKey = (this.props.savedMetric.metric_name || this.props.adhocMetric.isNew) && _Array$isArray(this.props.savedMetricsOptions) && this.props.savedMetricsOptions.length > 0 ? SAVED_TAB_KEY : this.props.adhocMetric.expressionType;\n    this.onSave = _bindInstanceProperty(_context = this.onSave).call(_context, this);\n    this.onResetStateAndClose = _bindInstanceProperty(_context2 = this.onResetStateAndClose).call(_context2, this);\n    this.onColumnChange = _bindInstanceProperty(_context3 = this.onColumnChange).call(_context3, this);\n    this.onAggregateChange = _bindInstanceProperty(_context4 = this.onAggregateChange).call(_context4, this);\n    this.onSavedMetricChange = _bindInstanceProperty(_context5 = this.onSavedMetricChange).call(_context5, this);\n    this.onSqlExpressionChange = _bindInstanceProperty(_context6 = this.onSqlExpressionChange).call(_context6, this);\n    this.onDragDown = _bindInstanceProperty(_context7 = this.onDragDown).call(_context7, this);\n    this.onMouseMove = _bindInstanceProperty(_context8 = this.onMouseMove).call(_context8, this);\n    this.onMouseUp = _bindInstanceProperty(_context9 = this.onMouseUp).call(_context9, this);\n    this.onTabChange = _bindInstanceProperty(_context10 = this.onTabChange).call(_context10, this);\n    this.handleAceEditorRef = _bindInstanceProperty(_context11 = this.handleAceEditorRef).call(_context11, this);\n    this.refreshAceEditor = _bindInstanceProperty(_context12 = this.refreshAceEditor).call(_context12, this);\n\n    this.state = {\n      adhocMetric: this.props.adhocMetric,\n      savedMetric: this.props.savedMetric,\n      width: startingWidth,\n      height: startingHeight };\n\n\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentDidMount() {\n    this.props.getCurrentTab(this.defaultActiveTabKey);\n  }\n\n  componentDidUpdate(prevProps, prevState) {var _prevState$adhocMetri, _this$state$adhocMetr, _prevState$adhocMetri2, _this$state$adhocMetr2, _prevState$adhocMetri3, _prevState$adhocMetri4, _this$state$adhocMetr3, _this$state$adhocMetr4, _prevState$savedMetri, _this$state$savedMetr;\n    if (\n    ((_prevState$adhocMetri = prevState.adhocMetric) == null ? void 0 : _prevState$adhocMetri.sqlExpression) !== ((_this$state$adhocMetr =\n    this.state.adhocMetric) == null ? void 0 : _this$state$adhocMetr.sqlExpression) ||\n    ((_prevState$adhocMetri2 = prevState.adhocMetric) == null ? void 0 : _prevState$adhocMetri2.aggregate) !== ((_this$state$adhocMetr2 = this.state.adhocMetric) == null ? void 0 : _this$state$adhocMetr2.aggregate) ||\n    ((_prevState$adhocMetri3 = prevState.adhocMetric) == null ? void 0 : (_prevState$adhocMetri4 = _prevState$adhocMetri3.column) == null ? void 0 : _prevState$adhocMetri4.column_name) !== ((_this$state$adhocMetr3 =\n    this.state.adhocMetric) == null ? void 0 : (_this$state$adhocMetr4 = _this$state$adhocMetr3.column) == null ? void 0 : _this$state$adhocMetr4.column_name) ||\n    ((_prevState$savedMetri = prevState.savedMetric) == null ? void 0 : _prevState$savedMetri.metric_name) !== ((_this$state$savedMetr = this.state.savedMetric) == null ? void 0 : _this$state$savedMetr.metric_name))\n    {var _this$state$savedMetr2, _this$state$savedMetr3, _this$state$adhocMetr5;\n      this.props.getCurrentLabel({\n        savedMetricLabel:\n        ((_this$state$savedMetr2 = this.state.savedMetric) == null ? void 0 : _this$state$savedMetr2.verbose_name) || ((_this$state$savedMetr3 =\n        this.state.savedMetric) == null ? void 0 : _this$state$savedMetr3.metric_name),\n        adhocMetricLabel: (_this$state$adhocMetr5 = this.state.adhocMetric) == null ? void 0 : _this$state$adhocMetr5.getDefaultLabel() });\n\n    }\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onSave() {var _this$props$savedMetr;\n    const { adhocMetric, savedMetric } = this.state;\n\n    const metric = savedMetric != null && savedMetric.metric_name ? savedMetric : adhocMetric;\n    const oldMetric = (_this$props$savedMetr = this.props.savedMetric) != null && _this$props$savedMetr.metric_name ?\n    this.props.savedMetric :\n    this.props.adhocMetric;\n    this.props.onChange(\n    {\n      ...metric },\n\n    oldMetric);\n\n    this.props.onClose();\n  }\n\n  onResetStateAndClose() {\n    this.setState(\n    {\n      adhocMetric: this.props.adhocMetric,\n      savedMetric: this.props.savedMetric },\n\n    this.props.onClose);\n\n  }\n\n  onColumnChange(columnId) {var _context13;\n    const column = _findInstanceProperty(_context13 = this.props.columns).call(_context13, column => column.id === columnId);\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        column,\n        expressionType: EXPRESSION_TYPES.SIMPLE }),\n\n      savedMetric: undefined }));\n\n  }\n\n  onAggregateChange(aggregate) {\n    // we construct this object explicitly to overwrite the value in the case aggregate is null\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        aggregate,\n        expressionType: EXPRESSION_TYPES.SIMPLE }),\n\n      savedMetric: undefined }));\n\n  }\n\n  onSavedMetricChange(savedMetricId) {var _context14;\n    const savedMetric = _findInstanceProperty(_context14 = this.props.savedMetricsOptions).call(_context14,\n    metric => metric.id === savedMetricId);\n\n    this.setState(prevState => ({\n      savedMetric,\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        column: undefined,\n        aggregate: undefined,\n        sqlExpression: undefined,\n        expressionType: EXPRESSION_TYPES.SIMPLE }) }));\n\n\n  }\n\n  onSqlExpressionChange(sqlExpression) {\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        sqlExpression,\n        expressionType: EXPRESSION_TYPES.SQL }),\n\n      savedMetric: undefined }));\n\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n      this.dragStartWidth + (e.clientX - this.dragStartX),\n      startingWidth),\n\n      height: Math.max(\n      this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n      startingHeight) });\n\n\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onTabChange(tab) {\n    this.refreshAceEditor();\n    this.props.getCurrentTab(tab);\n  }\n\n  handleAceEditorRef(ref) {\n    if (ref) {\n      this.aceEditorRef = ref;\n    }\n  }\n\n  refreshAceEditor() {\n    _setTimeout(() => {\n      if (this.aceEditorRef) {\n        this.aceEditorRef.editor.resize();\n      }\n    }, 0);\n  }\n\n  renderColumnOption(option) {\n    const column = { ...option };\n    if (column.metric_name && !column.verbose_name) {\n      column.verbose_name = column.metric_name;\n    }\n    return (\n      ___EmotionJSX(ColumnOptionStyle, null,\n      ___EmotionJSX(ColumnOption, { column: column, showType: true })));\n\n\n  }\n\n  render() {var _savedMetricsOptions$;\n    const {\n      adhocMetric: propsAdhocMetric,\n      savedMetric: propsSavedMetric,\n      columns,\n      savedMetricsOptions,\n      onChange,\n      onClose,\n      onResize,\n      datasourceType,\n      ...popoverProps } =\n    this.props;\n    const { adhocMetric, savedMetric } = this.state;\n    const keywords = _concatInstanceProperty(sqlKeywords).call(sqlKeywords,\n    _mapInstanceProperty(columns).call(columns, column => ({\n      name: column.column_name,\n      value: column.column_name,\n      score: 50,\n      meta: 'column' })));\n\n\n\n    const columnValue =\n    adhocMetric.column && adhocMetric.column.column_name ||\n    adhocMetric.inferSqlExpressionColumn();\n\n    // autofocus on column if there's no value in column; otherwise autofocus on aggregate\n    const columnSelectProps = {\n      placeholder: t('%s column(s)', columns.length),\n      value: columnValue,\n      onChange: this.onColumnChange,\n      allowClear: true,\n      showSearch: true,\n      autoFocus: !columnValue,\n      filterOption: (input, option) => {var _context15;return (\n          _indexOfInstanceProperty(_context15 = option.filterBy.toLowerCase()).call(_context15, input.toLowerCase()) >= 0);} };\n\n\n    const aggregateSelectProps = {\n      placeholder: t('%s aggregates(s)', AGGREGATES_OPTIONS.length),\n      value: adhocMetric.aggregate || adhocMetric.inferSqlExpressionAggregate(),\n      onChange: this.onAggregateChange,\n      allowClear: true,\n      autoFocus: !!columnValue,\n      showSearch: true };\n\n\n    const savedSelectProps = {\n      placeholder: t('%s saved metric(s)', (_savedMetricsOptions$ = savedMetricsOptions == null ? void 0 : savedMetricsOptions.length) != null ? _savedMetricsOptions$ : 0),\n      value: (savedMetric == null ? void 0 : savedMetric.verbose_name) || (savedMetric == null ? void 0 : savedMetric.metric_name),\n      onChange: this.onSavedMetricChange,\n      allowClear: true,\n      showSearch: true,\n      autoFocus: true,\n      filterOption: (input, option) => {var _context16;return (\n          _indexOfInstanceProperty(_context16 = option.filterBy.toLowerCase()).call(_context16, input.toLowerCase()) >= 0);} };\n\n\n    if (this.props.datasourceType === 'druid') {var _context17;\n      aggregateSelectProps.options = _filterInstanceProperty(_context17 = aggregateSelectProps.options).call(_context17,\n      aggregate => aggregate !== 'AVG');\n\n    }\n\n    const stateIsValid = adhocMetric.isValid() || (savedMetric == null ? void 0 : savedMetric.metric_name);\n    const hasUnsavedChanges =\n    !adhocMetric.equals(propsAdhocMetric) ||\n    !(\n    typeof (savedMetric == null ? void 0 : savedMetric.metric_name) === 'undefined' &&\n    typeof (propsSavedMetric == null ? void 0 : propsSavedMetric.metric_name) === 'undefined') &&\n\n    (savedMetric == null ? void 0 : savedMetric.metric_name) !== (propsSavedMetric == null ? void 0 : propsSavedMetric.metric_name);\n\n    return (\n      ___EmotionJSX(\"div\", _extends({\n        id: \"metrics-edit-popover\",\n        \"data-test\": \"metrics-edit-popover\" },\n      popoverProps),\n\n      ___EmotionJSX(Tabs, {\n        id: \"adhoc-metric-edit-tabs\",\n        \"data-test\": \"adhoc-metric-edit-tabs\",\n        defaultActiveKey: this.defaultActiveTabKey,\n        className: \"adhoc-metric-edit-tabs\",\n        style: { height: this.state.height, width: this.state.width },\n        onChange: this.onTabChange,\n        allowOverflow: true },\n\n      ___EmotionJSX(Tabs.TabPane, { key: SAVED_TAB_KEY, tab: t('Saved') },\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(FormLabel, null,\n      ___EmotionJSX(\"strong\", null, t('Saved metric'))),\n\n      ___EmotionJSX(Select, _extends({},\n      savedSelectProps, {\n        name: \"select-saved\",\n        getPopupContainer: triggerNode => triggerNode.parentNode }),\n\n      _Array$isArray(savedMetricsOptions) &&\n      _mapInstanceProperty(savedMetricsOptions).call(savedMetricsOptions, (savedMetric) =>\n      ___EmotionJSX(Select.Option, {\n        value: savedMetric.id,\n        filterBy:\n        savedMetric.verbose_name || savedMetric.metric_name,\n\n        key: savedMetric.id },\n\n      ___EmotionJSX(MetricOption, { metric: savedMetric, showType: true })))))),\n\n\n\n\n\n      ___EmotionJSX(Tabs.TabPane, { key: EXPRESSION_TYPES.SIMPLE, tab: t('Simple') },\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(FormLabel, null,\n      ___EmotionJSX(\"strong\", null, t('column'))),\n\n      ___EmotionJSX(Select, _extends({},\n      columnSelectProps, {\n        name: \"select-column\",\n        getPopupContainer: triggerNode => triggerNode.parentNode }),\n\n      _mapInstanceProperty(columns).call(columns, (column) =>\n      ___EmotionJSX(Select.Option, {\n        value: column.id,\n        filterBy: column.verbose_name || column.column_name,\n        key: column.id },\n\n      this.renderColumnOption(column))))),\n\n\n\n\n      ___EmotionJSX(FormGroup, null,\n      ___EmotionJSX(FormLabel, null,\n      ___EmotionJSX(\"strong\", null, t('aggregate'))),\n\n      ___EmotionJSX(Select, _extends({},\n      aggregateSelectProps, {\n        name: \"select-aggregate\",\n        getPopupContainer: triggerNode => triggerNode.parentNode }),\n\n      _mapInstanceProperty(AGGREGATES_OPTIONS).call(AGGREGATES_OPTIONS, (option) =>\n      ___EmotionJSX(Select.Option, { value: option, key: option },\n      option))))),\n\n\n\n\n\n      ___EmotionJSX(Tabs.TabPane, {\n        key: EXPRESSION_TYPES.SQL,\n        tab: t('Custom SQL'),\n        \"data-test\": \"adhoc-metric-edit-tab#custom\" },\n\n      this.props.datasourceType !== 'druid' ?\n      ___EmotionJSX(FormGroup, { \"data-test\": \"sql-editor\" },\n      ___EmotionJSX(SQLEditor, {\n        showLoadingForImport: true,\n        ref: this.handleAceEditorRef,\n        keywords: keywords,\n        height: `${this.state.height - 80}px`,\n        onChange: this.onSqlExpressionChange,\n        width: \"100%\",\n        showGutter: false,\n        value:\n        adhocMetric.sqlExpression || adhocMetric.translateToSql(),\n\n        editorProps: { $blockScrolling: true },\n        enableLiveAutocompletion: true,\n        className: \"adhoc-filter-sql-editor\",\n        wrapEnabled: true })) :\n\n\n\n      ___EmotionJSX(\"div\", { className: \"custom-sql-disabled-message\" }, \"Custom SQL Metrics are not available on druid datasources\"))),\n\n\n\n\n\n      ___EmotionJSX(\"div\", null,\n      ___EmotionJSX(Button, {\n        buttonSize: \"small\",\n        onClick: this.onResetStateAndClose,\n        \"data-test\": \"AdhocMetricEdit#cancel\",\n        cta: true },\n\n      t('Close')),\n\n      ___EmotionJSX(Button, {\n        disabled: !stateIsValid,\n        buttonStyle:\n        hasUnsavedChanges && stateIsValid ? 'primary' : 'default',\n\n        buttonSize: \"small\",\n        \"data-test\": \"AdhocMetricEdit#save\",\n        onClick: this.onSave,\n        cta: true },\n\n      t('Save')),\n\n      ___EmotionJSX(ResizeIcon, {\n        role: \"button\",\n        \"aria-label\": \"Resize\",\n        tabIndex: 0,\n        onMouseDown: this.onDragDown,\n        className: \"fa fa-expand edit-popover-resize text-muted\" }))));\n\n\n\n\n  } // @ts-ignore\n  __reactstandin__regenerateByEval(key, code) {// @ts-ignore\n    this[key] = eval(code);}}AdhocMetricEditPopover.propTypes = propTypes;\nAdhocMetricEditPopover.defaultProps = defaultProps;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(propTypes, \"propTypes\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(defaultProps, \"defaultProps\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(ResizeIcon, \"ResizeIcon\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(ColumnOptionStyle, \"ColumnOptionStyle\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(SAVED_TAB_KEY, \"SAVED_TAB_KEY\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingWidth, \"startingWidth\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(startingHeight, \"startingHeight\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");reactHotLoader.register(AdhocMetricEditPopover, \"AdhocMetricEditPopover\", \"/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/app/superset-frontend/src/explore/components/controls/MetricControl/AdhocMetricEditPopover.jsx"],"names":["React","PropTypes","FormGroup","Tabs","Button","NativeSelect","Select","styled","t","ColumnOption","MetricOption","FormLabel","SQLEditor","sqlKeywords","noOp","AGGREGATES_OPTIONS","columnType","savedMetricType","AdhocMetric","EXPRESSION_TYPES","propTypes","adhocMetric","instanceOf","isRequired","onChange","func","onClose","onResize","getCurrentTab","getCurrentLabel","columns","arrayOf","savedMetricsOptions","savedMetric","datasourceType","string","defaultProps","ResizeIcon","i","theme","gridUnit","ColumnOptionStyle","span","SAVED_TAB_KEY","startingWidth","startingHeight","AdhocMetricEditPopover","PureComponent","constructor","props","defaultActiveTabKey","metric_name","isNew","length","expressionType","onSave","onResetStateAndClose","onColumnChange","onAggregateChange","onSavedMetricChange","onSqlExpressionChange","onDragDown","onMouseMove","onMouseUp","onTabChange","handleAceEditorRef","refreshAceEditor","state","width","height","document","addEventListener","componentDidMount","componentDidUpdate","prevProps","prevState","sqlExpression","aggregate","column","column_name","savedMetricLabel","verbose_name","adhocMetricLabel","getDefaultLabel","componentWillUnmount","removeEventListener","metric","oldMetric","setState","columnId","id","duplicateWith","SIMPLE","undefined","savedMetricId","SQL","e","dragStartX","clientX","dragStartY","clientY","dragStartWidth","dragStartHeight","Math","max","tab","ref","aceEditorRef","editor","resize","renderColumnOption","option","render","propsAdhocMetric","propsSavedMetric","popoverProps","keywords","name","value","score","meta","columnValue","inferSqlExpressionColumn","columnSelectProps","placeholder","allowClear","showSearch","autoFocus","filterOption","input","filterBy","toLowerCase","aggregateSelectProps","inferSqlExpressionAggregate","savedSelectProps","options","stateIsValid","isValid","hasUnsavedChanges","equals","triggerNode","parentNode","translateToSql","$blockScrolling"],"mappings":"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","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable camelcase */\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { FormGroup } from 'react-bootstrap';\nimport Tabs from 'src/common/components/Tabs';\nimport Button from 'src/components/Button';\nimport { NativeSelect as Select } from 'src/components/Select';\nimport { styled, t } from '@superset-ui/core';\nimport { ColumnOption, MetricOption } from '@superset-ui/chart-controls';\n\nimport FormLabel from 'src/components/FormLabel';\nimport { SQLEditor } from 'src/components/AsyncAceEditor';\nimport sqlKeywords from 'src/SqlLab/utils/sqlKeywords';\nimport { noOp } from 'src/utils/common';\n\nimport { AGGREGATES_OPTIONS } from 'src/explore/constants';\nimport columnType from './columnType';\nimport savedMetricType from './savedMetricType';\nimport AdhocMetric, { EXPRESSION_TYPES } from './AdhocMetric';\n\nconst propTypes = {\n  adhocMetric: PropTypes.instanceOf(AdhocMetric).isRequired,\n  onChange: PropTypes.func.isRequired,\n  onClose: PropTypes.func.isRequired,\n  onResize: PropTypes.func.isRequired,\n  getCurrentTab: PropTypes.func,\n  getCurrentLabel: PropTypes.func,\n  columns: PropTypes.arrayOf(columnType),\n  savedMetricsOptions: PropTypes.arrayOf(savedMetricType),\n  savedMetric: savedMetricType,\n  datasourceType: PropTypes.string,\n};\n\nconst defaultProps = {\n  columns: [],\n  getCurrentTab: noOp,\n};\n\nconst ResizeIcon = styled.i`\n  margin-left: ${({ theme }) => theme.gridUnit * 2}px;\n`;\n\nconst ColumnOptionStyle = styled.span`\n  .option-label {\n    display: inline;\n  }\n`;\n\nexport const SAVED_TAB_KEY = 'SAVED';\n\nconst startingWidth = 320;\nconst startingHeight = 240;\n\nexport default class AdhocMetricEditPopover extends React.PureComponent {\n  // \"Saved\" is a default tab unless there are no saved metrics for dataset\n  defaultActiveTabKey =\n    (this.props.savedMetric.metric_name || this.props.adhocMetric.isNew) &&\n    Array.isArray(this.props.savedMetricsOptions) &&\n    this.props.savedMetricsOptions.length > 0\n      ? SAVED_TAB_KEY\n      : this.props.adhocMetric.expressionType;\n\n  constructor(props) {\n    super(props);\n    this.onSave = this.onSave.bind(this);\n    this.onResetStateAndClose = this.onResetStateAndClose.bind(this);\n    this.onColumnChange = this.onColumnChange.bind(this);\n    this.onAggregateChange = this.onAggregateChange.bind(this);\n    this.onSavedMetricChange = this.onSavedMetricChange.bind(this);\n    this.onSqlExpressionChange = this.onSqlExpressionChange.bind(this);\n    this.onDragDown = this.onDragDown.bind(this);\n    this.onMouseMove = this.onMouseMove.bind(this);\n    this.onMouseUp = this.onMouseUp.bind(this);\n    this.onTabChange = this.onTabChange.bind(this);\n    this.handleAceEditorRef = this.handleAceEditorRef.bind(this);\n    this.refreshAceEditor = this.refreshAceEditor.bind(this);\n\n    this.state = {\n      adhocMetric: this.props.adhocMetric,\n      savedMetric: this.props.savedMetric,\n      width: startingWidth,\n      height: startingHeight,\n    };\n\n    document.addEventListener('mouseup', this.onMouseUp);\n  }\n\n  componentDidMount() {\n    this.props.getCurrentTab(this.defaultActiveTabKey);\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (\n      prevState.adhocMetric?.sqlExpression !==\n        this.state.adhocMetric?.sqlExpression ||\n      prevState.adhocMetric?.aggregate !== this.state.adhocMetric?.aggregate ||\n      prevState.adhocMetric?.column?.column_name !==\n        this.state.adhocMetric?.column?.column_name ||\n      prevState.savedMetric?.metric_name !== this.state.savedMetric?.metric_name\n    ) {\n      this.props.getCurrentLabel({\n        savedMetricLabel:\n          this.state.savedMetric?.verbose_name ||\n          this.state.savedMetric?.metric_name,\n        adhocMetricLabel: this.state.adhocMetric?.getDefaultLabel(),\n      });\n    }\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('mouseup', this.onMouseUp);\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onSave() {\n    const { adhocMetric, savedMetric } = this.state;\n\n    const metric = savedMetric?.metric_name ? savedMetric : adhocMetric;\n    const oldMetric = this.props.savedMetric?.metric_name\n      ? this.props.savedMetric\n      : this.props.adhocMetric;\n    this.props.onChange(\n      {\n        ...metric,\n      },\n      oldMetric,\n    );\n    this.props.onClose();\n  }\n\n  onResetStateAndClose() {\n    this.setState(\n      {\n        adhocMetric: this.props.adhocMetric,\n        savedMetric: this.props.savedMetric,\n      },\n      this.props.onClose,\n    );\n  }\n\n  onColumnChange(columnId) {\n    const column = this.props.columns.find(column => column.id === columnId);\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        column,\n        expressionType: EXPRESSION_TYPES.SIMPLE,\n      }),\n      savedMetric: undefined,\n    }));\n  }\n\n  onAggregateChange(aggregate) {\n    // we construct this object explicitly to overwrite the value in the case aggregate is null\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        aggregate,\n        expressionType: EXPRESSION_TYPES.SIMPLE,\n      }),\n      savedMetric: undefined,\n    }));\n  }\n\n  onSavedMetricChange(savedMetricId) {\n    const savedMetric = this.props.savedMetricsOptions.find(\n      metric => metric.id === savedMetricId,\n    );\n    this.setState(prevState => ({\n      savedMetric,\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        column: undefined,\n        aggregate: undefined,\n        sqlExpression: undefined,\n        expressionType: EXPRESSION_TYPES.SIMPLE,\n      }),\n    }));\n  }\n\n  onSqlExpressionChange(sqlExpression) {\n    this.setState(prevState => ({\n      adhocMetric: prevState.adhocMetric.duplicateWith({\n        sqlExpression,\n        expressionType: EXPRESSION_TYPES.SQL,\n      }),\n      savedMetric: undefined,\n    }));\n  }\n\n  onDragDown(e) {\n    this.dragStartX = e.clientX;\n    this.dragStartY = e.clientY;\n    this.dragStartWidth = this.state.width;\n    this.dragStartHeight = this.state.height;\n    document.addEventListener('mousemove', this.onMouseMove);\n  }\n\n  onMouseMove(e) {\n    this.props.onResize();\n    this.setState({\n      width: Math.max(\n        this.dragStartWidth + (e.clientX - this.dragStartX),\n        startingWidth,\n      ),\n      height: Math.max(\n        this.dragStartHeight + (e.clientY - this.dragStartY) * 2,\n        startingHeight,\n      ),\n    });\n  }\n\n  onMouseUp() {\n    document.removeEventListener('mousemove', this.onMouseMove);\n  }\n\n  onTabChange(tab) {\n    this.refreshAceEditor();\n    this.props.getCurrentTab(tab);\n  }\n\n  handleAceEditorRef(ref) {\n    if (ref) {\n      this.aceEditorRef = ref;\n    }\n  }\n\n  refreshAceEditor() {\n    setTimeout(() => {\n      if (this.aceEditorRef) {\n        this.aceEditorRef.editor.resize();\n      }\n    }, 0);\n  }\n\n  renderColumnOption(option) {\n    const column = { ...option };\n    if (column.metric_name && !column.verbose_name) {\n      column.verbose_name = column.metric_name;\n    }\n    return (\n      <ColumnOptionStyle>\n        <ColumnOption column={column} showType />\n      </ColumnOptionStyle>\n    );\n  }\n\n  render() {\n    const {\n      adhocMetric: propsAdhocMetric,\n      savedMetric: propsSavedMetric,\n      columns,\n      savedMetricsOptions,\n      onChange,\n      onClose,\n      onResize,\n      datasourceType,\n      ...popoverProps\n    } = this.props;\n    const { adhocMetric, savedMetric } = this.state;\n    const keywords = sqlKeywords.concat(\n      columns.map(column => ({\n        name: column.column_name,\n        value: column.column_name,\n        score: 50,\n        meta: 'column',\n      })),\n    );\n\n    const columnValue =\n      (adhocMetric.column && adhocMetric.column.column_name) ||\n      adhocMetric.inferSqlExpressionColumn();\n\n    // autofocus on column if there's no value in column; otherwise autofocus on aggregate\n    const columnSelectProps = {\n      placeholder: t('%s column(s)', columns.length),\n      value: columnValue,\n      onChange: this.onColumnChange,\n      allowClear: true,\n      showSearch: true,\n      autoFocus: !columnValue,\n      filterOption: (input, option) =>\n        option.filterBy.toLowerCase().indexOf(input.toLowerCase()) >= 0,\n    };\n\n    const aggregateSelectProps = {\n      placeholder: t('%s aggregates(s)', AGGREGATES_OPTIONS.length),\n      value: adhocMetric.aggregate || adhocMetric.inferSqlExpressionAggregate(),\n      onChange: this.onAggregateChange,\n      allowClear: true,\n      autoFocus: !!columnValue,\n      showSearch: true,\n    };\n\n    const savedSelectProps = {\n      placeholder: t('%s saved metric(s)', savedMetricsOptions?.length ?? 0),\n      value: savedMetric?.verbose_name || savedMetric?.metric_name,\n      onChange: this.onSavedMetricChange,\n      allowClear: true,\n      showSearch: true,\n      autoFocus: true,\n      filterOption: (input, option) =>\n        option.filterBy.toLowerCase().indexOf(input.toLowerCase()) >= 0,\n    };\n\n    if (this.props.datasourceType === 'druid') {\n      aggregateSelectProps.options = aggregateSelectProps.options.filter(\n        aggregate => aggregate !== 'AVG',\n      );\n    }\n\n    const stateIsValid = adhocMetric.isValid() || savedMetric?.metric_name;\n    const hasUnsavedChanges =\n      !adhocMetric.equals(propsAdhocMetric) ||\n      (!(\n        typeof savedMetric?.metric_name === 'undefined' &&\n        typeof propsSavedMetric?.metric_name === 'undefined'\n      ) &&\n        savedMetric?.metric_name !== propsSavedMetric?.metric_name);\n\n    return (\n      <div\n        id=\"metrics-edit-popover\"\n        data-test=\"metrics-edit-popover\"\n        {...popoverProps}\n      >\n        <Tabs\n          id=\"adhoc-metric-edit-tabs\"\n          data-test=\"adhoc-metric-edit-tabs\"\n          defaultActiveKey={this.defaultActiveTabKey}\n          className=\"adhoc-metric-edit-tabs\"\n          style={{ height: this.state.height, width: this.state.width }}\n          onChange={this.onTabChange}\n          allowOverflow\n        >\n          <Tabs.TabPane key={SAVED_TAB_KEY} tab={t('Saved')}>\n            <FormGroup>\n              <FormLabel>\n                <strong>{t('Saved metric')}</strong>\n              </FormLabel>\n              <Select\n                {...savedSelectProps}\n                name=\"select-saved\"\n                getPopupContainer={triggerNode => triggerNode.parentNode}\n              >\n                {Array.isArray(savedMetricsOptions) &&\n                  savedMetricsOptions.map(savedMetric => (\n                    <Select.Option\n                      value={savedMetric.id}\n                      filterBy={\n                        savedMetric.verbose_name || savedMetric.metric_name\n                      }\n                      key={savedMetric.id}\n                    >\n                      <MetricOption metric={savedMetric} showType />\n                    </Select.Option>\n                  ))}\n              </Select>\n            </FormGroup>\n          </Tabs.TabPane>\n          <Tabs.TabPane key={EXPRESSION_TYPES.SIMPLE} tab={t('Simple')}>\n            <FormGroup>\n              <FormLabel>\n                <strong>{t('column')}</strong>\n              </FormLabel>\n              <Select\n                {...columnSelectProps}\n                name=\"select-column\"\n                getPopupContainer={triggerNode => triggerNode.parentNode}\n              >\n                {columns.map(column => (\n                  <Select.Option\n                    value={column.id}\n                    filterBy={column.verbose_name || column.column_name}\n                    key={column.id}\n                  >\n                    {this.renderColumnOption(column)}\n                  </Select.Option>\n                ))}\n              </Select>\n            </FormGroup>\n            <FormGroup>\n              <FormLabel>\n                <strong>{t('aggregate')}</strong>\n              </FormLabel>\n              <Select\n                {...aggregateSelectProps}\n                name=\"select-aggregate\"\n                getPopupContainer={triggerNode => triggerNode.parentNode}\n              >\n                {AGGREGATES_OPTIONS.map(option => (\n                  <Select.Option value={option} key={option}>\n                    {option}\n                  </Select.Option>\n                ))}\n              </Select>\n            </FormGroup>\n          </Tabs.TabPane>\n          <Tabs.TabPane\n            key={EXPRESSION_TYPES.SQL}\n            tab={t('Custom SQL')}\n            data-test=\"adhoc-metric-edit-tab#custom\"\n          >\n            {this.props.datasourceType !== 'druid' ? (\n              <FormGroup data-test=\"sql-editor\">\n                <SQLEditor\n                  showLoadingForImport\n                  ref={this.handleAceEditorRef}\n                  keywords={keywords}\n                  height={`${this.state.height - 80}px`}\n                  onChange={this.onSqlExpressionChange}\n                  width=\"100%\"\n                  showGutter={false}\n                  value={\n                    adhocMetric.sqlExpression || adhocMetric.translateToSql()\n                  }\n                  editorProps={{ $blockScrolling: true }}\n                  enableLiveAutocompletion\n                  className=\"adhoc-filter-sql-editor\"\n                  wrapEnabled\n                />\n              </FormGroup>\n            ) : (\n              <div className=\"custom-sql-disabled-message\">\n                Custom SQL Metrics are not available on druid datasources\n              </div>\n            )}\n          </Tabs.TabPane>\n        </Tabs>\n        <div>\n          <Button\n            buttonSize=\"small\"\n            onClick={this.onResetStateAndClose}\n            data-test=\"AdhocMetricEdit#cancel\"\n            cta\n          >\n            {t('Close')}\n          </Button>\n          <Button\n            disabled={!stateIsValid}\n            buttonStyle={\n              hasUnsavedChanges && stateIsValid ? 'primary' : 'default'\n            }\n            buttonSize=\"small\"\n            data-test=\"AdhocMetricEdit#save\"\n            onClick={this.onSave}\n            cta\n          >\n            {t('Save')}\n          </Button>\n          <ResizeIcon\n            role=\"button\"\n            aria-label=\"Resize\"\n            tabIndex={0}\n            onMouseDown={this.onDragDown}\n            className=\"fa fa-expand edit-popover-resize text-muted\"\n          />\n        </div>\n      </div>\n    );\n  }\n}\nAdhocMetricEditPopover.propTypes = propTypes;\nAdhocMetricEditPopover.defaultProps = defaultProps;\n"]},"metadata":{},"sourceType":"module"}